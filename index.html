<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RoadShow â€” Concerts On Your Route</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%230a0a0a' rx='4'/%3E%3Ctext x='16' y='23' text-anchor='middle' font-size='20' fill='%23e8c547'%3E%E2%99%AA%3C/text%3E%3C/svg%3E">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@300;400;500&family=Playfair+Display:ital,wght@0,700;1,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>

<style>
:root {
  --bg:#0a0a0a; --bg2:#111; --bg3:#1a1a1a; --panel:#121212; --border:#222;
  --accent:#e8c547; --accent2:#ff5c38; --text:#f0ede6;
  --text2:#888; --text3:#555; --green:#4ade80; --r:4px;
  --spotify:#1DB954; --spotify-hover:#1ed760;
  --lastfm:#B90000; --lastfm-hover:#d40000;
  --deezer:#A238FF; --deezer-hover:#b85cff;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;min-height:100vh;overflow-x:hidden;}

/* â”€â”€â”€ Grain â”€â”€â”€ */
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;opacity:.3;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");}

/* â”€â”€â”€ Header â”€â”€â”€ */
header{padding:12px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;
  justify-content:space-between;position:sticky;top:0;z-index:100;
  background:rgba(10,10,10,.97);backdrop-filter:blur(14px);}
.logo{font-family:'Bebas Neue',sans-serif;font-size:1.9rem;letter-spacing:.14em;color:var(--accent);
  text-shadow:0 0 50px rgba(232,197,71,.2);}
.logo span{color:var(--accent2);}
.htagline{font-size:.52rem;color:var(--text3);letter-spacing:.16em;text-transform:uppercase;margin-top:1px;}
.pills{display:flex;gap:5px;}
.pill{font-size:.48rem;padding:3px 7px;border-radius:2px;letter-spacing:.08em;text-transform:uppercase;border:1px solid;transition:all .25s;white-space:nowrap;}
.p-tm{color:#60a5fa;border-color:rgba(96,165,250,.35);background:rgba(96,165,250,.07);}
.p-jb{color:var(--green);border-color:rgba(74,222,128,.35);background:rgba(74,222,128,.07);}
.p-eb{color:#f97316;border-color:rgba(249,115,22,.35);background:rgba(249,115,22,.07);}
.p-sp{color:#a78bfa;border-color:rgba(167,139,250,.35);background:rgba(167,139,250,.07);}
.p-dz{color:#A238FF;border-color:rgba(162,56,255,.35);background:rgba(162,56,255,.07);}
.p-off{color:var(--text3);border-color:var(--border);background:transparent;opacity:.38;}

/* â”€â”€â”€ 3-Column Layout â”€â”€â”€ */
.app{display:grid;grid-template-columns:320px 340px 1fr;height:calc(100vh - 53px);}

/* â”€â”€â”€ Left: Controls â”€â”€â”€ */
.sidebar{background:var(--panel);border-right:1px solid var(--border);overflow-y:auto;display:flex;flex-direction:column;}
.sidebar::-webkit-scrollbar{width:3px;}
.sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

.ss{padding:14px 18px;border-bottom:1px solid var(--border);}
.sl{font-size:.5rem;letter-spacing:.22em;text-transform:uppercase;color:var(--text3);margin-bottom:12px;
  display:flex;align-items:center;gap:8px;}
.sl::after{content:'';flex:1;height:1px;background:var(--border);}
.ig{margin-bottom:9px;}
.il{font-size:.56rem;color:var(--text2);margin-bottom:4px;display:flex;align-items:center;gap:5px;}
.dot{width:6px;height:6px;border-radius:50%;display:inline-block;flex-shrink:0;}
.ds{background:var(--green);box-shadow:0 0 5px rgba(74,222,128,.4);}
.de{background:var(--accent2);box-shadow:0 0 5px rgba(255,92,56,.4);}
.dm{background:var(--accent);box-shadow:0 0 5px rgba(232,197,71,.3);}

input[type=text],input[type=date]{width:100%;background:var(--bg3);border:1px solid var(--border);
  color:var(--text);padding:8px 11px;font-family:'DM Mono',monospace;font-size:.7rem;
  border-radius:var(--r);outline:none;transition:border-color .25s, box-shadow .25s;}
input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(232,197,71,.08);}
input::placeholder{color:var(--text3);}
input[type=date]{cursor:pointer;}
/* WebKit-only: guard with @supports selector() so Firefox skips silently */
@supports selector(input::-webkit-calendar-picker-indicator){
  input[type=date]::-webkit-calendar-picker-indicator{filter:invert(.7);cursor:pointer;}
}

/* Calendar */
.cal-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:2px;}
.cal-group{position:relative;}
.cal-label{font-family:'Bebas Neue',sans-serif;font-size:.68rem;letter-spacing:.1em;
  text-transform:uppercase;margin-bottom:5px;display:flex;align-items:center;gap:5px;}
.cal-label.start{color:var(--green);}
.cal-label.end{color:var(--accent2);}
.cal-label .cal-icon{font-size:.72rem;}
.cal-group input[type=date]{font-size:.66rem;padding:8px 10px;}
.cal-group.start input:focus{border-color:var(--green);box-shadow:0 0 0 2px rgba(74,222,128,.1);}
.cal-group.end input:focus{border-color:var(--accent2);box-shadow:0 0 0 2px rgba(255,92,56,.1);}
.trip-meta{display:flex;justify-content:space-between;align-items:center;padding:4px 2px;margin-bottom:2px;}
.trip-days{font-size:.55rem;color:var(--accent);letter-spacing:.06em;}
.trip-days span{color:var(--text3);}

/* Sliders */
.sw{display:flex;align-items:center;gap:8px;}
input[type=range]{-webkit-appearance:none;appearance:none;flex:1;height:2px;background:var(--border);outline:none;border:none;}
/* WebKit-only thumb: guard so Firefox skips silently instead of logging a bad-selector warning */
@supports selector(input::-webkit-slider-thumb){
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;
    background:var(--accent);cursor:pointer;box-shadow:0 0 8px rgba(232,197,71,.3);}
  input[type=range]::-webkit-slider-thumb:hover{box-shadow:0 0 14px rgba(232,197,71,.5);}
}
/* Firefox thumb */
input[type=range]::-moz-range-thumb{width:13px;height:13px;border-radius:50%;border:none;
  background:var(--accent);cursor:pointer;box-shadow:0 0 8px rgba(232,197,71,.3);}
input[type=range]::-moz-range-thumb:hover{box-shadow:0 0 14px rgba(232,197,71,.5);}
.sv{font-size:.64rem;color:var(--accent);min-width:50px;text-align:right;font-weight:500;}

/* API list */
.api-list{display:flex;flex-direction:column;gap:5px;}
.api-row{display:flex;align-items:center;gap:7px;padding:7px 10px;background:var(--bg3);
  border:1px solid var(--border);border-radius:var(--r);transition:all .25s;}
.api-row:hover{border-color:var(--text3);}
.api-row.on{border-color:rgba(74,222,128,.4);}
.api-row.err{border-color:rgba(255,92,56,.5);background:rgba(255,92,56,.03);}
.api-row.err .api-name{color:var(--accent2);}
.api-row.err .api-note{color:var(--accent2);opacity:1;}
.api-row.dim{opacity:.35;}
.api-ico{width:18px;height:18px;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.api-ico svg{width:16px;height:16px;}
.api-info{flex:1;min-width:0;}
.api-note{font-size:.5rem;color:var(--text3);margin-top:1px;}
.api-row.on .api-note{color:var(--green);}
.api-btn{font-family:'DM Mono',monospace;font-size:.52rem;padding:3px 8px;border-radius:var(--r);
  cursor:pointer;letter-spacing:.05em;border:1px solid var(--border);background:transparent;
  color:var(--text2);transition:all .18s;white-space:nowrap;}
.api-btn:hover{border-color:var(--accent);color:var(--accent);}
.api-row.on .api-btn{border-color:rgba(74,222,128,.3);color:var(--green);}
.api-btn-group{display:flex;gap:4px;}
.api-btn-sp-login{font-family:'DM Mono',monospace;font-size:.52rem;padding:3px 8px;border-radius:var(--r);
  cursor:pointer;letter-spacing:.05em;border:1px solid var(--spotify);background:var(--spotify);
  color:#000;font-weight:700;transition:all .18s;white-space:nowrap;}
.api-btn-sp-login:hover{background:var(--spotify-hover);border-color:var(--spotify-hover);}
.api-row.on .api-btn-sp-login{background:var(--spotify);border-color:var(--spotify);color:#000;}
.api-divider{font-size:.44rem;letter-spacing:.18em;text-transform:uppercase;color:var(--text3);
  padding:3px 0;text-align:center;opacity:.5;}

/* Search button */
.search-btn{width:100%;padding:12px;background:var(--accent);color:#0a0a0a;border:none;
  font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:.16em;cursor:pointer;
  border-radius:var(--r);transition:all .2s;position:relative;overflow:hidden;}
.search-btn:hover{background:#f0d060;transform:translateY(-1px);box-shadow:0 4px 20px rgba(232,197,71,.2);}
.search-btn:active{transform:translateY(0);}
.search-btn:disabled{background:var(--bg3);color:var(--text3);cursor:not-allowed;transform:none;box-shadow:none;}

/* â”€â”€â”€ Middle: Results Panel â”€â”€â”€ */
.results-panel{background:var(--bg);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.results-header{padding:12px 16px;border-bottom:1px solid var(--border);background:var(--panel);flex-shrink:0;}
.rh{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px;}
.rc{font-size:.56rem;color:var(--accent);letter-spacing:.1em;text-transform:uppercase;}
.rctrl{display:flex;gap:4px;align-items:center;}
.fb{font-family:'DM Mono',monospace;font-size:.5rem;padding:2px 7px;border-radius:2px;cursor:pointer;
  letter-spacing:.05em;border:1px solid var(--border);background:transparent;color:var(--text3);transition:all .18s;}
.fb:hover{opacity:.8;}
.fb.f-tm{border-color:#60a5fa;color:#60a5fa;background:rgba(96,165,250,.08);}
.fb.f-jb{border-color:var(--green);color:var(--green);background:rgba(74,222,128,.08);}
.fb.f-eb{border-color:#f97316;color:#f97316;background:rgba(249,115,22,.08);}
.sort-sel{background:var(--bg3);border:1px solid var(--border);color:var(--text2);
  font-family:'DM Mono',monospace;font-size:.54rem;padding:2px 7px;border-radius:var(--r);outline:none;cursor:pointer;}

/* Cache indicator */
.cache-bar{display:flex;align-items:center;gap:6px;padding:6px 16px;border-bottom:1px solid var(--border);
  background:rgba(232,197,71,.04);flex-shrink:0;}
.cache-bar.hidden{display:none;}
.cache-dot{width:5px;height:5px;border-radius:50%;background:var(--green);flex-shrink:0;
  box-shadow:0 0 5px rgba(74,222,128,.5);}
.cache-text{font-size:.5rem;color:var(--text3);letter-spacing:.04em;}
.cache-text strong{color:var(--accent);font-weight:400;}
.cache-clear{font-family:'DM Mono',monospace;font-size:.48rem;padding:2px 6px;border-radius:2px;cursor:pointer;
  border:1px solid var(--border);background:transparent;color:var(--text3);transition:all .15s;margin-left:auto;}
.cache-clear:hover{border-color:var(--accent2);color:var(--accent2);}

/* Results list */
.results-scroll{flex:1;overflow-y:auto;padding:10px 12px;}
.results-scroll::-webkit-scrollbar{width:3px;}
.results-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

.cc{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);
  padding:11px 13px;margin-bottom:6px;cursor:pointer;transition:all .2s;
  position:relative;overflow:hidden;animation:fadeIn .3s ease both;}
.cc::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;opacity:0;transition:opacity .2s;}
.cc.s-tm::before{background:#60a5fa;} .cc.s-jb::before{background:var(--green);}
.cc.s-eb::before{background:#f97316;}
.cc:hover{transform:translateX(3px);border-color:var(--text3);}
.cc:hover::before{opacity:1;}
.cc.s-tm:hover{border-color:rgba(96,165,250,.4);}
.cc.s-jb:hover{border-color:rgba(74,222,128,.4);}
.cc.s-eb:hover{border-color:rgba(249,115,22,.4);}
.cc.s-sp:hover{border-color:rgba(29,185,84,.4);}
.cc.s-dz:hover{border-color:rgba(162,56,255,.4);}
.cc.s-lf::before{background:#d51007;}.cc.s-lf:hover{border-color:rgba(213,16,7,.4);}
.t-lf{color:#d51007;border-color:rgba(213,16,7,.22);background:rgba(213,16,7,.07);}
.p-lf{color:#d51007;border-color:rgba(213,16,7,.35);background:rgba(213,16,7,.07);}
/* API row badges */
.api-name{font-size:.6rem;color:var(--text);display:flex;align-items:center;gap:5px;}
.api-badge{font-size:.42rem;padding:2px 5px;border-radius:2px;letter-spacing:.05em;
  text-transform:uppercase;white-space:nowrap;border:1px solid;}
.badge-soon{color:rgba(245,158,11,.85);border-color:rgba(245,158,11,.3);background:rgba(245,158,11,.06);}
.badge-primary{color:#d51007;border-color:rgba(213,16,7,.3);background:rgba(213,16,7,.06);}
.ct{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:3px;}
.an{font-family:'Playfair Display',serif;font-size:.82rem;color:var(--text);font-weight:700;
  flex:1;padding-right:6px;line-height:1.25;}
.cd{font-size:.5rem;color:var(--accent);letter-spacing:.06em;text-align:right;white-space:nowrap;line-height:1.6;}
.vn{font-size:.6rem;color:var(--text2);margin-bottom:5px;}
.ctags{display:flex;gap:4px;flex-wrap:wrap;}
.tag{font-size:.46rem;padding:2px 5px;border-radius:2px;letter-spacing:.06em;text-transform:uppercase;border:1px solid;}
.t-city{color:#b8a040;border-color:rgba(232,197,71,.18);background:rgba(232,197,71,.07);}
.t-tm{color:#60a5fa;border-color:rgba(96,165,250,.22);background:rgba(96,165,250,.07);}
.t-jb{color:var(--green);border-color:rgba(74,222,128,.22);background:rgba(74,222,128,.07);}
.t-eb{color:#f97316;border-color:rgba(249,115,22,.22);background:rgba(249,115,22,.07);}
.t-sp{color:#1db954;border-color:rgba(29,185,84,.22);background:rgba(29,185,84,.07);}
.t-dz{color:#A238FF;border-color:rgba(162,56,255,.22);background:rgba(162,56,255,.07);}
.t-gen{color:var(--text3);border-color:var(--border);background:transparent;}
.ca{display:flex;gap:5px;margin-top:7px;padding-top:7px;border-top:1px solid var(--border);}
.bs{font-family:'DM Mono',monospace;font-size:.52rem;padding:3px 8px;border-radius:var(--r);
  cursor:pointer;letter-spacing:.06em;text-transform:uppercase;transition:all .16s;
  text-decoration:none;display:inline-flex;align-items:center;gap:3px;border:1px solid;}
.b-tk{background:var(--accent2);color:white;border-color:var(--accent2);}
.b-tk:hover{background:#ff7055;box-shadow:0 2px 10px rgba(255,92,56,.25);}
.b-gh{background:transparent;color:var(--text2);border-color:var(--border);}
.b-gh:hover{border-color:var(--text2);color:var(--text);}


/* Empty states */
.empty{text-align:center;padding:40px 16px;color:var(--text3);}
.empty .ei{font-size:2.4rem;margin-bottom:12px;opacity:.2;}
.empty p{font-size:.62rem;line-height:1.9;}

/* â”€â”€â”€ Right: Map â”€â”€â”€ */
.map-panel{position:relative;display:flex;flex-direction:column;}
#map{flex:1;background:#0d1117;min-height:200px;}
.map-ov{position:absolute;top:14px;right:14px;background:rgba(10,10,10,.94);
  border:1px solid var(--border);border-radius:var(--r);padding:11px 15px;
  font-size:.56rem;color:var(--text2);backdrop-filter:blur(10px);z-index:500;min-width:165px;display:none;}
.ms{display:flex;justify-content:space-between;gap:16px;margin-bottom:4px;}
.ms:last-child{margin-bottom:0;}
.msv{color:var(--accent);font-weight:500;}
.src-bk{margin-top:8px;padding-top:8px;border-top:1px solid var(--border);}
.sk{display:flex;justify-content:space-between;margin-bottom:3px;font-size:.54rem;}
.lb{height:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));
  width:0%;transition:width .4s ease;position:absolute;top:0;left:0;right:0;z-index:600;}

/* â”€â”€â”€ Modal â”€â”€â”€ */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;
  display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .22s;}
.mo.open{opacity:1;pointer-events:all;}
.md{background:var(--panel);border:1px solid var(--border);border-radius:6px;
  padding:24px;max-width:400px;width:90%;transform:translateY(10px);transition:transform .22s;}
.mo.open .md{transform:translateY(0);}
.md h3{font-family:'Bebas Neue',sans-serif;font-size:1.25rem;letter-spacing:.1em;color:var(--accent);margin-bottom:8px;}
.md p{font-size:.64rem;color:var(--text2);line-height:1.75;margin-bottom:12px;}
.md input{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);
  padding:9px 13px;font-family:'DM Mono',monospace;font-size:.72rem;border-radius:var(--r);
  outline:none;margin-bottom:12px;}
.md input:focus{border-color:var(--accent);}
.ma{display:flex;gap:8px;justify-content:flex-end;}
.b-cancel{background:transparent;border:1px solid var(--border);color:var(--text2);padding:7px 14px;
  font-family:'DM Mono',monospace;font-size:.62rem;border-radius:var(--r);cursor:pointer;transition:all .15s;}
.b-cancel:hover{border-color:var(--text2);}
.b-save{background:var(--accent);border:none;color:#0a0a0a;padding:7px 14px;
  font-family:'DM Mono',monospace;font-size:.62rem;border-radius:var(--r);cursor:pointer;font-weight:500;transition:all .15s;}
.b-save:hover{background:#f0d060;}
.b-oauth{width:100%;padding:11px;border:none;border-radius:var(--r);font-family:'DM Mono',monospace;
  font-size:.72rem;letter-spacing:.06em;cursor:pointer;font-weight:500;transition:all .18s;
  display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:0;}
.b-oauth:hover{opacity:.92;transform:translateY(-1px);}
.b-oauth:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.b-oauth.sp-btn{background:var(--spotify);color:#000;}
.b-oauth.sp-btn:hover{background:var(--spotify-hover);}
.b-oauth.lf-btn{background:var(--lastfm);color:#fff;}
.b-oauth.lf-btn:hover{background:var(--lastfm-hover);}
.b-oauth.dz-btn{background:var(--deezer);color:#fff;}
.b-oauth.dz-btn:hover{background:var(--deezer-hover);}

/* OAuth loading state */
.oauth-loading{display:flex;align-items:center;justify-content:center;gap:8px;
  padding:11px;font-size:.62rem;color:var(--text2);letter-spacing:.08em;}
.oauth-spinner{width:14px;height:14px;border:2px solid var(--border);
  border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* OAuth success state */
.oauth-success{display:flex;align-items:center;justify-content:center;gap:8px;
  padding:11px;font-size:.62rem;color:var(--green);letter-spacing:.08em;}
.oauth-success svg{width:16px;height:16px;fill:var(--green);}

/* OAuth error state (inline in modal) */
.oauth-error{padding:8px 12px;margin-bottom:10px;font-size:.54rem;line-height:1.7;
  color:var(--accent2);background:rgba(255,92,56,.07);
  border:1px solid rgba(255,92,56,.25);border-radius:var(--r);}

/* Tab toggle for Deezer OAuth vs ARL */
.auth-tabs{display:flex;gap:0;margin-bottom:12px;border:1px solid var(--border);border-radius:var(--r);overflow:hidden;}
.auth-tab{flex:1;padding:7px 10px;font-family:'DM Mono',monospace;font-size:.56rem;
  letter-spacing:.06em;text-align:center;cursor:pointer;border:none;
  background:transparent;color:var(--text3);transition:all .15s;}
.auth-tab.active{background:var(--bg3);color:var(--text);border-bottom:2px solid var(--deezer);}
.auth-tab:hover:not(.active){color:var(--text2);}

@keyframes fadeIn{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}

/* â”€â”€â”€ Dynamic Stop Inputs â”€â”€â”€ */
.stop-row{display:flex;align-items:center;gap:5px;margin-bottom:5px;}
.stop-row:last-child{margin-bottom:0;}
.stop-input{flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--text);
  padding:8px 11px;font-family:'DM Mono',monospace;font-size:.7rem;border-radius:var(--r);
  outline:none;transition:border-color .25s,box-shadow .25s;min-width:0;}
.stop-input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(232,197,71,.08);}
.stop-input::placeholder{color:var(--text3);}
.stop-add-btn,.stop-rm-btn{flex-shrink:0;width:24px;height:24px;border-radius:var(--r);
  border:1px solid var(--border);background:transparent;color:var(--text2);
  font-family:'DM Mono',monospace;font-size:.85rem;line-height:1;cursor:pointer;
  display:flex;align-items:center;justify-content:center;transition:all .18s;}
.stop-add-btn:hover{border-color:var(--accent);color:var(--accent);}
.stop-rm-btn{color:var(--text3);}
.stop-rm-btn:hover{border-color:var(--accent2);color:var(--accent2);}
@keyframes stopSlideIn{from{opacity:0;transform:translateY(-4px);}to{opacity:1;transform:translateY(0);}}

/* â”€â”€â”€ Search log (left panel, below Find Shows) â”€â”€â”€ */
#searchLog{display:none;margin-top:8px;background:rgba(8,8,8,.95);border:1px solid var(--border);
  border-radius:var(--r);max-height:150px;overflow-y:auto;font-family:'DM Mono',monospace;}
#searchLog::-webkit-scrollbar{width:3px;}
#searchLog::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.log-hdr{font-size:.42rem;letter-spacing:.18em;text-transform:uppercase;color:var(--text3);
  padding:5px 9px 4px;border-bottom:1px solid rgba(255,255,255,.05);}
.log-body{padding:3px 6px 5px;}
.log-line{display:flex;gap:7px;align-items:baseline;padding:1px 0;line-height:1.6;}
.log-ts{font-size:.4rem;color:var(--text3);opacity:.35;flex-shrink:0;letter-spacing:.02em;}
.log-ok{color:#4ade80;font-size:.5rem;} .log-err{color:var(--accent2);font-size:.5rem;}
.log-warn{color:var(--accent);font-size:.5rem;} .log-info{color:var(--text2);font-size:.5rem;}

/* â”€â”€â”€ Artist summary (middle panel, above results scroll) â”€â”€â”€ */
#artistSummary{flex-shrink:0;border-bottom:1px solid var(--border);overflow:hidden;
  max-height:0;transition:max-height .3s ease;}
#artistSummary.open{max-height:220px;}
.as-toggle{display:flex;align-items:center;justify-content:space-between;padding:5px 12px 4px;
  cursor:pointer;user-select:none;background:transparent;border:none;border-bottom:1px solid transparent;
  width:100%;text-align:left;transition:background .15s;}
.as-toggle:hover{background:rgba(255,255,255,.02);}
.as-toggle.open{border-bottom-color:rgba(255,255,255,.05);}
.as-label{font-family:'DM Mono',monospace;font-size:.46rem;letter-spacing:.1em;text-transform:uppercase;color:var(--text3);}
.as-caret{font-size:.45rem;color:var(--text3);transition:transform .2s;line-height:1;padding-left:6px;}
.as-inner{overflow-y:auto;max-height:175px;padding:8px 12px 10px;}
.as-inner::-webkit-scrollbar{width:3px;}
.as-inner::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
.as-svc{margin-bottom:7px;}.as-svc:last-child{margin-bottom:0;}
.as-svc-name{font-family:'DM Mono',monospace;font-size:.44rem;letter-spacing:.12em;
  text-transform:uppercase;margin-bottom:4px;}
.as-sp .as-svc-name{color:#1db954;} .as-lf .as-svc-name{color:#d51007;} .as-dz .as-svc-name{color:#A238FF;}
.artist-chip{display:inline-block;font-family:'DM Mono',monospace;font-size:.48rem;padding:2px 7px;
  border-radius:10px;margin:2px 2px;border:1px solid;line-height:1.5;white-space:nowrap;}
.chip-sp{color:#1db954;border-color:rgba(29,185,84,.3);background:rgba(29,185,84,.06);}
.chip-lf{color:#d51007;border-color:rgba(213,16,7,.3);background:rgba(213,16,7,.06);}
.chip-dz{color:#A238FF;border-color:rgba(162,56,255,.3);background:rgba(162,56,255,.06);}
</style>
</head>
<body>

<header>
  <div>
    <div class="logo">Road<span>Show</span></div>
    <div class="htagline">Concerts along your route</div>
  </div>
  <div class="pills">
    <span class="pill p-tm p-off" id="hdr-tm">Ticketmaster</span>
    <span class="pill p-jb p-off" id="hdr-jb">Jambase</span>
    <span class="pill p-eb p-off" id="hdr-eb">Eventbrite</span>
    <span class="pill p-lf p-off" id="hdr-lf">Last.fm</span>
    <span class="pill p-sp p-off" id="hdr-sp">Spotify</span>
    <span class="pill p-dz p-off" id="hdr-dz">Deezer</span>
  </div>
</header>

<div class="app">

  <!-- â•â•â• LEFT: Controls â•â•â• -->
  <div class="sidebar">
    <div class="ss">
      <div class="sl">Your Route</div>
      <div class="ig"><div class="il"><span class="dot ds"></span> Starting City</div>
        <input type="text" id="startCity" placeholder="e.g. Nashville, TN"/></div>
      <div class="ig"><div class="il"><span class="dot de"></span> Destination</div>
        <input type="text" id="endCity" placeholder="e.g. New Orleans, LA"/></div>
      <div class="ig" id="stopsSection">
        <div class="il"><span class="dot dm"></span> Stops</div>
        <div id="stopsList">
          <div class="stop-row" data-index="0">
            <input type="text" class="stop-input" placeholder="e.g. Memphis, TN"/>
            <button class="stop-add-btn" onclick="addStopInput()" title="Add another stop">+</button>
          </div>
        </div>
      </div>
    </div>

    <div class="ss">
      <div class="sl">Trip Calendar</div>
      <div class="cal-row">
        <div class="cal-group start">
          <div class="cal-label start"><span class="cal-icon">ðŸŸ¢</span> Start Driving</div>
          <input type="date" id="dateStart"/>
        </div>
        <div class="cal-group end">
          <div class="cal-label end"><span class="cal-icon">ðŸ”´</span> End Trip</div>
          <input type="date" id="dateEnd"/>
        </div>
      </div>
      <div class="trip-meta"><div class="trip-days" id="tripDays"><span>Select dates</span></div></div>
      <div class="ig">
        <div class="il">Search radius</div>
        <div class="sw"><input type="range" id="radiusSlider" min="10" max="150" value="50"/><span class="sv" id="radiusVal">50 mi</span></div>
      </div>
      <div class="ig">
        <div class="il">Date buffer (Â± days)</div>
        <div class="sw"><input type="range" id="bufferSlider" min="0" max="7" value="2"/><span class="sv" id="bufferVal">Â±2 days</span></div>
      </div>
    </div>

    <div class="ss">
      <div class="sl">Concert Sources</div>
      <div class="api-list">
        <div class="api-row" id="row-tm">
          <div class="api-ico">ðŸŽŸ</div>
          <div class="api-info"><div class="api-name">Ticketmaster</div><div class="api-note" id="note-tm">Major shows Â· not connected</div></div>
          <button class="api-btn" onclick="openModal('tm')">Connect</button>
        </div>
        <div class="api-row" id="row-jb">
          <div class="api-ico">ðŸŽ¸</div>
          <div class="api-info"><div class="api-name">Jambase</div><div class="api-note" id="note-jb">Indie venues Â· not connected</div></div>
          <button class="api-btn" onclick="openModal('jb')">Connect</button>
        </div>
        <div class="api-row" id="row-eb">
          <div class="api-ico">ðŸŽª</div>
          <div class="api-info"><div class="api-name">Eventbrite</div><div class="api-note" id="note-eb">DIY shows Â· not connected</div></div>
          <button class="api-btn" onclick="openModal('eb')">Connect</button>
        </div>
        <div class="api-divider">â”€â”€ music services â”€â”€</div>
        <div class="api-row dim" id="row-lf">
          <div class="api-ico"><svg viewBox="0 0 24 24" fill="#B90000"><path d="M10.584 17.21l-.88-2.392s-1.43 1.594-3.573 1.594c-1.897 0-3.244-1.649-3.244-4.288 0-3.381 1.704-4.591 3.381-4.591 2.42 0 3.189 1.567 3.849 3.574l.88 2.749c.88 2.666 2.529 4.81 7.284 4.81 3.409 0 5.718-1.044 5.718-3.793 0-2.227-1.265-3.381-3.627-3.933l-1.758-.385c-1.21-.275-1.567-.77-1.567-1.594 0-.935.742-1.484 1.952-1.484 1.32 0 2.034.495 2.144 1.677l2.749-.33c-.22-2.474-1.924-3.492-4.729-3.492-2.474 0-4.893.935-4.893 3.932 0 1.87.907 3.051 3.189 3.601l1.87.44c1.402.33 1.87.88 1.87 1.704 0 1.045-.99 1.484-2.859 1.484-2.776 0-3.932-1.457-4.591-3.464l-.907-2.749c-1.155-3.574-2.997-4.894-6.653-4.894C2.144 5.333 0 7.89 0 12.233c0 4.179 2.144 6.434 5.993 6.434 3.107 0 4.591-1.457 4.591-1.457z"/></svg></div>
          <div class="api-info">
            <div class="api-name">Last.fm <span class="api-badge badge-primary">â˜… Primary</span></div>
            <div class="api-note" id="note-lf">Match top artists Â· not connected</div>
          </div>
          <div class="api-btn-group">
            <button class="api-btn-sp-login" style="background:var(--lastfm);border-color:var(--lastfm);color:#fff" onclick="openLfLogin()">Login</button>
            <button class="api-btn" style="border-color:var(--green)" onclick="openModal('lf','dev')">Dev Login</button>
          </div>
        </div>
        <div class="api-row dim" id="row-sp">
          <div class="api-ico"><svg viewBox="0 0 24 24" fill="#1DB954"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg></div>
          <div class="api-info">
            <div class="api-name">Spotify</div>
            <div class="api-note" id="note-sp">Top artists Â· not connected</div>
          </div>
          <div class="api-btn-group">
            <button class="api-btn-sp-login" onclick="openSpLogin()">Login</button>
            <button class="api-btn" style="border-color:var(--green)" onclick="openModal('sp','clientid')">Dev Login</button>
          </div>
        </div>
        <div class="api-row dim" id="row-dz">
          <div class="api-ico"><svg viewBox="0 0 24 24" fill="#A238FF"><path d="M18.81 4.16v3.03H24V4.16h-5.19zM6.27 8.38v3.027h5.19V8.38H6.27zm12.54 0v3.027H24V8.38h-5.19zM6.27 12.566v3.027h5.19v-3.027H6.27zm6.27 0v3.027h5.19v-3.027h-5.19zm6.27 0v3.027H24v-3.027h-5.19zM0 16.752V19.8h5.19v-3.048H0zm6.27 0V19.8h5.19v-3.048H6.27zm6.27 0V19.8h5.19v-3.048h-5.19zm6.27 0V19.8H24v-3.048h-5.19z"/></svg></div>
          <div class="api-info">
            <div class="api-name">Deezer</div>
            <div class="api-note" id="note-dz">Favorite artists Â· not connected</div>
          </div>
          <button class="api-btn" onclick="openModal('dz')">Connect</button>
        </div>
      </div>
    </div>

    <div class="ss" style="border-bottom:none;">
      <button class="search-btn" id="searchBtn" onclick="searchConcerts()">âŸ¶ Find Shows</button>
      <div id="searchLog"></div>
    </div>
  </div>

  <!-- â•â•â• MIDDLE: Results â•â•â• -->
  <div class="results-panel">
    <div class="results-header" id="resultsHeader">
      <div class="rh">
        <div class="rc" id="rcLabel">No results yet</div>
        <div class="rctrl" id="rctrlBar" style="display:none;">
          <button class="fb f-tm" id="flt-tm" onclick="toggleFilter('tm')">TM</button>
          <button class="fb f-jb" id="flt-jb" onclick="toggleFilter('jb')">JB</button>
          <button class="fb f-eb" id="flt-eb" onclick="toggleFilter('eb')">EB</button>
          <select class="sort-sel" onchange="sortBy(this.value)">
            <option value="date">Date</option>
            <option value="artist">Artist</option>
            <option value="source">Source</option>
            <option value="city">City</option>
          </select>
        </div>
      </div>
    </div>
    <div class="cache-bar hidden" id="cacheBar">
      <div class="cache-dot"></div>
      <div class="cache-text" id="cacheText">Cached</div>
      <button class="cache-clear" onclick="clearCache()">Clear Cache</button>
    </div>
    <div id="artistSummary"></div>
    <div class="results-scroll" id="resultsScroll">
      <div class="empty">
        <div class="ei">ðŸŽ¸</div>
        <p>Enter your route and trip dates,<br>then hit <strong style="color:var(--accent)">Find Shows</strong>.<br><br>
        Connect <strong style="color:var(--accent)">Last.fm</strong> to personalize<br>results to artists you already love.<br><br>
        Requires at least one concert source â€”<br>Ticketmaster, Jambase, or Eventbrite.</p>
      </div>
    </div>
  </div>

  <!-- â•â•â• RIGHT: Map â•â•â• -->
  <div class="map-panel">
    <div class="lb" id="lb"></div>
    <div id="map"></div>
    <div class="map-ov" id="mapOv">
      <div class="ms"><span>Shows found</span><span class="msv" id="stShows">0</span></div>
      <div class="ms"><span>Visible</span><span class="msv" id="stVisible">0</span></div>
      <div class="ms"><span>Route</span><span class="msv" id="stDist">â€”</span></div>
      <div class="ms"><span>Trip</span><span class="msv" id="stTrip">â€”</span></div>
      <div class="src-bk" id="srcBk"></div>
    </div>
  </div>

</div>

<!-- Modal -->
<div class="mo" id="modalEl" onclick="closeModalOutside(event)">
  <div class="md">
    <h3 id="mTitle">Connect</h3>
    <p id="mDesc"></p>
    <!-- Error display area -->
    <div id="mErrorArea" style="display:none"></div>
    <!-- Spotify server-OAuth section: always shown for Spotify when server has client ID -->
    <div id="mSpOAuthSection" style="display:none;margin-bottom:10px">
      <button class="b-oauth sp-btn" id="mSpOAuthBtn" onclick="startModalOAuth()">Login</button>
      <p style="font-size:.5rem;color:var(--text3);letter-spacing:.1em;text-transform:uppercase;text-align:center;margin-top:8px;margin-bottom:0">â€” or enter your own client id below â€”</p>
    </div>
    <!-- OAuth section: shown when site has pre-configured credentials (Last.fm / legacy) -->
    <div id="mOAuthSection" style="display:none;margin-bottom:4px">
      <button class="b-oauth" id="mOAuthBtn" onclick="startModalOAuth()">Login</button>
    </div>
    <!-- Loading state -->
    <div id="mLoadingSection" style="display:none">
      <div class="oauth-loading">
        <div class="oauth-spinner"></div>
        <span id="mLoadingText">Authorizing...</span>
      </div>
    </div>
    <!-- Success state -->
    <div id="mSuccessSection" style="display:none">
      <div class="oauth-success">
        <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        <span id="mSuccessText">Connected!</span>
      </div>
    </div>
    <!-- Deezer auth tabs (OAuth vs ARL) -->
    <div id="mDeezerTabs" style="display:none">
      <div class="auth-tabs">
        <button class="auth-tab active" id="dzTabOAuth" onclick="switchDzTab('oauth')">OAuth Login</button>
        <button class="auth-tab" id="dzTabARL" onclick="switchDzTab('arl')">ARL Cookie</button>
      </div>
    </div>
    <!-- Deezer OAuth sub-section -->
    <div id="mDzOAuthSection" style="display:none">
      <button class="b-oauth dz-btn" id="mDzOAuthBtn" onclick="startModalOAuth()">Login with Deezer</button>
    </div>
    <!-- Manual section: shown for API-key services or as fallback -->
    <div id="mManualSection">
      <input type="text" id="mInput" placeholder=""/>
      <div id="mInput2Wrap" style="display:none">
        <p style="font-size:.5rem;color:var(--text3);letter-spacing:.12em;text-transform:uppercase;margin-bottom:5px;margin-top:-8px" id="mInput2Label">API Key</p>
        <input type="text" id="mInput2" placeholder=""/>
      </div>
    </div>
    <div class="ma" id="mActions">
      <button class="b-cancel" onclick="closeModal()">Cancel</button>
      <button class="b-save" id="mSaveBtn" onclick="saveKey()">Save</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ Popup OAuth callback detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// When Last.fm or Deezer redirects back to our URL inside a popup window,
// we detect it immediately, cover the app UI with an overlay so it doesn't
// flash, then relay the auth result to the opener and close.
const _IS_POPUP_CB = !!(
  window.opener && window.opener !== window &&
  (new URLSearchParams(window.location.search).has('token') ||
   new URLSearchParams(window.location.search).has('error_reason'))
);
if (_IS_POPUP_CB) {
  const ov = document.createElement('div');
  ov.style.cssText = 'position:fixed;inset:0;background:#0a0a0a;z-index:99999;' +
    'display:flex;align-items:center;justify-content:center;' +
    'font-family:\'DM Mono\',monospace;color:#f0ede6';
  ov.innerHTML = '<div style="text-align:center">' +
    '<div class="oauth-spinner" style="width:24px;height:24px;margin:0 auto 14px"></div>' +
    '<div style="font-size:.62rem;letter-spacing:.15em;color:#555">AUTHORIZING...</div></div>';
  document.body.appendChild(ov);
}

// â”€â”€ Leaflet check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (typeof L === 'undefined') {
  document.getElementById('map').innerHTML =
    '<div style="padding:40px;color:#888;font-family:monospace;font-size:.8rem">âš  Map library failed to load. Check your connection and reload.</div>';
}

// â”€â”€ Dynamic Stop Inputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MAX_EXTRA_STOPS = 25;

function addStopInput() {
  const list = document.getElementById('stopsList');
  const rows = list.querySelectorAll('.stop-row');
  if (rows.length >= MAX_EXTRA_STOPS + 1) return; // 1 base + 25 extra

  // Swap + button on last row to - button if it just got a sibling
  const lastRow = rows[rows.length - 1];
  const lastAddBtn = lastRow.querySelector('.stop-add-btn');
  if (lastAddBtn) {
    lastAddBtn.classList.replace('stop-add-btn', 'stop-rm-btn');
    lastAddBtn.textContent = 'âˆ’';
    lastAddBtn.title = 'Remove this stop';
    lastAddBtn.onclick = () => removeStopInput(lastAddBtn);
  }

  const newRow = document.createElement('div');
  newRow.className = 'stop-row';
  newRow.style.animation = 'stopSlideIn .2s ease both';
  newRow.innerHTML = `<input type="text" class="stop-input" placeholder="e.g. Baton Rouge, LA"/>` +
    (rows.length < MAX_EXTRA_STOPS
      ? `<button class="stop-add-btn" onclick="addStopInput()" title="Add another stop">+</button>`
      : ``);
  list.appendChild(newRow);
}

function removeStopInput(btn) {
  const list = document.getElementById('stopsList');
  const row = btn.closest('.stop-row');
  row.remove();

  // Restore + button on whatever is now the last row
  const rows = list.querySelectorAll('.stop-row');
  if (rows.length === 0) return;
  const lastRow = rows[rows.length - 1];
  // Remove any existing rm button on last row and ensure + button is present
  const existingRm = lastRow.querySelector('.stop-rm-btn');
  if (existingRm) {
    existingRm.classList.replace('stop-rm-btn', 'stop-add-btn');
    existingRm.textContent = '+';
    existingRm.title = 'Add another stop';
    existingRm.onclick = () => addStopInput();
  } else if (!lastRow.querySelector('.stop-add-btn')) {
    const addBtn = document.createElement('button');
    addBtn.className = 'stop-add-btn';
    addBtn.textContent = '+';
    addBtn.title = 'Add another stop';
    addBtn.onclick = () => addStopInput();
    lastRow.appendChild(addBtn);
  }
}

// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MCFG = {
  tm:{ title:'Ticketmaster API Key', placeholder:'Consumer Key', link:'https://developer.ticketmaster.com/products-and-docs/apis/getting-started/',
       desc:'Sign up free at developer.ticketmaster.com â€” instant key, no approval needed. Covers major venues, arenas, and festivals across North America.' },
  jb:{ title:'Jambase API Key', placeholder:'Jambase API Key', link:'https://www.jambase.com/article/jambase-api',
       desc:'Apply at jambase.com/api â€” usually approved within a day. Best source for indie artists, small clubs, and regional venues.' },
  eb:{ title:'Eventbrite Private Token', placeholder:'Private Token', link:'https://www.eventbrite.com/platform/api',
       desc:'Get a free token at eventbrite.com/platform â€” instant. Great for DIY shows and self-promoted gigs.' },
  lf:{ title:'Connect Last.fm', placeholder:'API Key', label2:'Shared Secret', placeholder2:'Shared Secret',
       link:'https://www.last.fm/api/account/create',
       desc:'Create a free API account at last.fm/api/account/create â€” takes 30 seconds, no approval needed. Paste your <strong style="color:var(--text)">API Key</strong> and <strong style="color:var(--text)">Shared Secret</strong> below, then click Authorize. Your Last.fm password never touches RoadShow.' },
  sp:{ title:'Connect Spotify', placeholder:'Spotify Client ID', link:'https://developer.spotify.com/dashboard',
       desc:'Create a free app at <a href="https://developer.spotify.com/dashboard" target="_blank" style="color:var(--accent);text-decoration:none">developer.spotify.com/dashboard</a>. In the app settings add <strong style="color:var(--accent)">' + location.origin + '</strong> as a <strong>Redirect URI</strong>. Then paste your Client ID below.' },
  dz:{ title:'Connect Deezer', placeholder:'Your Deezer ARL cookie', link:null,
       desc:'Open <a href="https://www.deezer.com" target="_blank" style="color:var(--accent);text-decoration:none">deezer.com</a> while logged in, then open DevTools (F12) â†’ Application â†’ Cookies â†’ www.deezer.com. Find the <strong style="color:var(--accent)">arl</strong> cookie and copy its full value (typically 192 characters).' }
};

const SRC_COLORS = { tm:'#60a5fa', jb:'#4ade80', eb:'#f97316' };
const SRC_LABELS = { tm:'Ticketmaster', jb:'Jambase', eb:'Eventbrite' };

// â”€â”€ SVG icon helpers (inline, no external assets) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function svgSpotifyIcon(size) {
  return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>`;
}
function svgLastfmIcon(size) {
  return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="currentColor"><path d="M10.584 17.21l-.88-2.392s-1.43 1.594-3.573 1.594c-1.897 0-3.244-1.649-3.244-4.288 0-3.381 1.704-4.591 3.381-4.591 2.42 0 3.189 1.567 3.849 3.574l.88 2.749c.88 2.666 2.529 4.81 7.284 4.81 3.409 0 5.718-1.044 5.718-3.793 0-2.227-1.265-3.381-3.627-3.933l-1.758-.385c-1.21-.275-1.567-.77-1.567-1.594 0-.935.742-1.484 1.952-1.484 1.32 0 2.034.495 2.144 1.677l2.749-.33c-.22-2.474-1.924-3.492-4.729-3.492-2.474 0-4.893.935-4.893 3.932 0 1.87.907 3.051 3.189 3.601l1.87.44c1.402.33 1.87.88 1.87 1.704 0 1.045-.99 1.484-2.859 1.484-2.776 0-3.932-1.457-4.591-3.464l-.907-2.749c-1.155-3.574-2.997-4.894-6.653-4.894C2.144 5.333 0 7.89 0 12.233c0 4.179 2.144 6.434 5.993 6.434 3.107 0 4.591-1.457 4.591-1.457z"/></svg>`;
}
function svgDeezerIcon(size) {
  return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="currentColor"><path d="M18.81 4.16v3.03H24V4.16h-5.19zM6.27 8.38v3.027h5.19V8.38H6.27zm12.54 0v3.027H24V8.38h-5.19zM6.27 12.566v3.027h5.19v-3.027H6.27zm6.27 0v3.027h5.19v-3.027h-5.19zm6.27 0v3.027H24v-3.027h-5.19zM0 16.752V19.8h5.19v-3.048H0zm6.27 0V19.8h5.19v-3.048H6.27zm6.27 0V19.8h5.19v-3.048h-5.19zm6.27 0V19.8H24v-3.048h-5.19z"/></svg>`;
}

// â”€â”€ App config (from /api/config â€” set env vars in Netlify Dashboard) â”€â”€â”€â”€â”€â”€
let appConfig = null;

async function loadConfig() {
  try {
    const res = await fetch('/api/config');
    if (res.ok) {
      appConfig = await res.json();
      // Swap modal descriptions for services that have pre-configured credentials
      if (appConfig.spotifyClientId) {
        MCFG.sp.desc = 'Log in with your Spotify account. Your top artists will be matched to shows along your route.';
      }
      if (appConfig.lastfmApiKey) {
        MCFG.lf.desc = 'Log in with your Last.fm account. Your top artists will be matched to shows along your route.';
      }
      if (appConfig.deezerAppId) {
        MCFG.dz.desc = 'Log in with your Deezer account. Your favorite artists will be matched to shows along your route.';
      }
      // Auto-apply Ticketmaster/Jambase keys if set in Netlify
      if (appConfig.ticketmasterKey && !state.keys.tm) {
        state.keys.tm = appConfig.ticketmasterKey;
        activateSourceUI('tm', 'Major shows Â· connected via server âœ“');
      }
      if (appConfig.jambaseKey && !state.keys.jb) {
        state.keys.jb = appConfig.jambaseKey;
        activateSourceUI('jb', 'Indie venues Â· connected via server âœ“');
      }
    } else {
      appConfig = {};
    }
  } catch (e) {
    console.log('Config endpoint not available â€” using manual key entry mode.');
    appConfig = {};
  }
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {
  keys:{}, concerts:[], markers:[], route:null, cityMarkers:[],
  modal:null, filters:new Set(['tm','jb','eb']),
  lastDiffDays: 0,
  spToken: null, spTokenExpiry: 0,
  lfKey: null, lfSecret: null, lfSession: null, lfUser: null,
  dzToken: null, dzUser: null, dzTokenExpiry: 0
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ CACHE SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Keyed by route + radius + connected sources.
// When the user narrows dates or changes the buffer slider,
// we filter the already-fetched data client-side instead of
// hitting the APIs again. A fresh fetch only happens when the
// route/radius/sources change or the requested date range
// exceeds what we already have cached.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const cache = {
  key: null,           // fingerprint of route + radius + keys
  dateFrom: null,      // widest date range we fetched
  dateTo: null,
  allConcerts: [],     // full unfiltered result set
  hits: 0,
  routeGeo: null,      // cached route + city markers so we don't re-geocode
  geoPoints: null,
  names: null
};
// Session-wide store: keeps every fetched result set for the lifetime of the page
// so that changing route/dates and reverting never re-hits the APIs.
const sessionCache = new Map(); // cacheKey â†’ {dateFrom, dateTo, allConcerts}

function cacheKey(names, radius, keys) {
  return JSON.stringify({ n:names.map(s=>s.toLowerCase().trim()), r:radius, tm:!!keys.tm, jb:!!keys.jb, eb:!!keys.eb, sp:!!state.spToken, lf:!!state.lfSession, dz:!!(state.dzToken||keys.dz) });
}

// â”€â”€ CSRF state parameter for OAuth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateOAuthState(service) {
  const arr = new Uint8Array(32);
  crypto.getRandomValues(arr);
  const stateVal = service + '_' + btoa(String.fromCharCode(...arr))
    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
  sessionStorage.setItem('oauth_state_' + service, stateVal);
  return stateVal;
}

function validateOAuthState(service, receivedState) {
  const expected = sessionStorage.getItem('oauth_state_' + service);
  sessionStorage.removeItem('oauth_state_' + service);
  if (!expected || expected !== receivedState) {
    console.error(`OAuth state mismatch for ${service}. Expected: ${expected}, received: ${receivedState}`);
    return false;
  }
  return true;
}

// â”€â”€ Modal state management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showModalLoading(text) {
  document.getElementById('mSpOAuthSection').style.display = 'none';
  document.getElementById('mOAuthSection').style.display = 'none';
  document.getElementById('mDzOAuthSection').style.display = 'none';
  document.getElementById('mManualSection').style.display = 'none';
  document.getElementById('mActions').style.display = 'none';
  document.getElementById('mLoadingText').textContent = text || 'Authorizing...';
  document.getElementById('mLoadingSection').style.display = '';
  document.getElementById('mSuccessSection').style.display = 'none';
  document.getElementById('mErrorArea').style.display = 'none';
}

function showModalSuccess(text) {
  document.getElementById('mLoadingSection').style.display = 'none';
  document.getElementById('mSuccessText').textContent = text || 'Connected!';
  document.getElementById('mSuccessSection').style.display = '';
  setTimeout(() => closeModal(), 1500);
}

function showModalError(msg) {
  const area = document.getElementById('mErrorArea');
  area.innerHTML = '<div class="oauth-error">' + esc(msg) + '</div>';
  area.style.display = '';
}

function clearModalError() {
  const area = document.getElementById('mErrorArea');
  area.innerHTML = '';
  area.style.display = 'none';
}

// â”€â”€ Deezer modal tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchDzTab(tab) {
  const oauthTab = document.getElementById('dzTabOAuth');
  const arlTab = document.getElementById('dzTabARL');
  const dzOAuthSec = document.getElementById('mDzOAuthSection');
  const manualSec = document.getElementById('mManualSection');
  const saveBtn = document.getElementById('mSaveBtn');
  const actions = document.getElementById('mActions');

  if (tab === 'oauth') {
    oauthTab.classList.add('active');
    arlTab.classList.remove('active');
    dzOAuthSec.style.display = '';
    manualSec.style.display = 'none';
    saveBtn.style.display = 'none';
  } else {
    arlTab.classList.add('active');
    oauthTab.classList.remove('active');
    dzOAuthSec.style.display = 'none';
    manualSec.style.display = '';
    saveBtn.style.display = '';
    saveBtn.textContent = 'Save ARL';
    actions.style.display = 'flex';
    document.getElementById('mInput').placeholder = MCFG.dz.placeholder;
    document.getElementById('mInput').value = state.keys.dz || '';
  }
}

function cacheDateCovers(df, dt) {
  if (!cache.dateFrom || !cache.dateTo) return false;
  return df >= cache.dateFrom && dt <= cache.dateTo;
}

function filterByDate(concerts, df, dt) {
  return concerts.filter(c => {
    if (!c.datetime) return true;
    const d = c.datetime.slice(0,10);
    return d >= df && d <= dt;
  });
}

function updateCacheUI() {
  const bar = document.getElementById('cacheBar');
  if (cache.allConcerts.length > 0) {
    bar.classList.remove('hidden');
    document.getElementById('cacheText').innerHTML =
      `<strong>${cache.allConcerts.length}</strong> cached Â· ${cache.dateFrom} â†’ ${cache.dateTo} Â· <strong>${cache.hits}</strong> hit${cache.hits!==1?'s':''}`;
  } else {
    bar.classList.add('hidden');
  }
}

function clearCache() {
  cache.key = null; cache.dateFrom = null; cache.dateTo = null;
  cache.allConcerts = []; cache.hits = 0;
  cache.routeGeo = null; cache.geoPoints = null; cache.names = null;
  sessionCache.clear();
  updateCacheUI();
  console.log('ðŸ—‘ Cache cleared');
}

// â”€â”€ Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const map = L.map('map', { zoomControl:false }).setView([37.5, -93.5], 5);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution:'Â© OpenStreetMap Â© Carto', maxZoom:19
}).addTo(map);
L.control.zoom({ position:'bottomright' }).addTo(map);

// â”€â”€ DOM init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('radiusSlider').oninput = e =>
  document.getElementById('radiusVal').textContent = e.target.value + ' mi';
document.getElementById('bufferSlider').oninput = e =>
  document.getElementById('bufferVal').textContent = 'Â±' + e.target.value + ' days';

const today = new Date();
const d1 = new Date(today); d1.setDate(today.getDate()+14);
const d2 = new Date(today); d2.setDate(today.getDate()+21);
document.getElementById('dateStart').value = fd(d1);
document.getElementById('dateEnd').value   = fd(d2);
updateTripDays();

document.getElementById('dateStart').addEventListener('change', updateTripDays);
document.getElementById('dateEnd').addEventListener('change', updateTripDays);

function updateTripDays() {
  const ds = document.getElementById('dateStart').value;
  const de = document.getElementById('dateEnd').value;
  const el = document.getElementById('tripDays');
  if (ds && de) {
    const diff = Math.ceil((new Date(de+'T00:00:00') - new Date(ds+'T00:00:00')) / 86400000);
    if (diff > 0)      el.innerHTML = `${diff} day${diff!==1?'s':''} on the road`;
    else if (diff===0) el.innerHTML = 'Same-day trip';
    else               el.innerHTML = '<span style="color:var(--accent2)">End date must be after start</span>';
  } else {
    el.innerHTML = '<span>Select dates</span>';
  }
}

document.querySelectorAll('input[type=text],input[type=date]')
  .forEach(el => el.addEventListener('keydown', e => { if(e.key==='Enter') searchConcerts(); }));

// â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fd(d) {
  return d.getFullYear() + '-' +
    String(d.getMonth()+1).padStart(2,'0') + '-' +
    String(d.getDate()).padStart(2,'0');
}

function fmtDt(iso) {
  if (!iso) return { date:'TBA', time:'' };
  const d = new Date(iso);
  return {
    date: d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}),
    time: d.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})
  };
}

function setLB(pct) { document.getElementById('lb').style.width = pct+'%'; }

function showEmpty(msg) {
  document.getElementById('resultsScroll').innerHTML =
    `<div class="empty"><div class="ei">ðŸŽµ</div><p>${msg}</p></div>`;
}

function clearMap() {
  if (state.route) { map.removeLayer(state.route); state.route = null; }
  state.markers.forEach(m => map.removeLayer(m));
  state.markers = [];
  state.cityMarkers.forEach(m => map.removeLayer(m));
  state.cityMarkers = [];
  document.getElementById('mapOv').style.display = 'none';
}

function clearConcertMarkers() {
  state.markers.forEach(m => map.removeLayer(m));
  state.markers = [];
}

function hav(la1,lo1,la2,lo2) {
  const R=6371,dL=(la2-la1)*Math.PI/180,dO=(lo2-lo1)*Math.PI/180;
  const a=Math.sin(dL/2)**2+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dO/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// â”€â”€ Last.fm tile LOGIN button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openLfLogin() {
  if (appConfig?.lastfmApiKey) {
    authorizeLastFm(appConfig.lastfmApiKey);
  } else {
    const note = document.getElementById('note-lf');
    if (note) {
      note.textContent = 'Error: Last.fm API Key not configured on server.';
      note.style.color = 'var(--accent2)';
    }
    console.error('Last.fm login failed: appConfig.lastfmApiKey is missing.');
  }
}

// â”€â”€ Last.fm helper for 1-click setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getLfClientIdDesc() {
  const uri = window.location.origin + '/callbacks';
  return '<strong style="color:var(--text)">Step 1:</strong> Create a free API account at ' +
    '<a href="https://www.last.fm/api/account/create" target="_blank" style="color:var(--accent);text-decoration:none">last.fm/api/account/create</a>.' +
    '<br><br>' +
    '<strong style="color:var(--text)">Step 2:</strong> Use this as your <strong>Callback URL</strong>:' +
    '<div id="lfRedirectUriBox" style="margin:6px 0;padding:6px 8px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);color:var(--accent);font-size:.55rem;word-break:break-all;font-family:\'DM Mono\',monospace;user-select:all;cursor:pointer" onclick="copyLfRedirectUri()" title="Click to copy">' + uri + '</div>' +
    '<button class="b-oauth lf-btn" style="margin-bottom:12px;font-size:.58rem;padding:6px;height:auto;letter-spacing:0" onclick="copyAndOpenLfDashboard()">1-Click: Copy URL & Open Dashboard</button>' +
    '<strong style="color:var(--text)">Step 3:</strong> Paste your <strong style="color:var(--accent)">API Key</strong> and <strong style="color:var(--accent)">Shared Secret</strong> below.';
}

async function copyLfRedirectUri() {
  const uri = window.location.origin + '/callbacks';
  try {
    await navigator.clipboard.writeText(uri);
    const box = document.getElementById('lfRedirectUriBox');
    if (box) {
      const old = box.textContent;
      box.textContent = 'COPIED TO CLIPBOARD âœ“';
      box.style.color = 'var(--green)';
      setTimeout(() => { box.textContent = old; box.style.color = ''; }, 2000);
    }
  } catch (err) { console.error('Failed to copy: ', err); }
}

function copyAndOpenLfDashboard() {
  copyLfRedirectUri();
  window.open('https://www.last.fm/api/account/create', '_blank');
}

// â”€â”€ Spotify tile LOGIN button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSpLogin() {
  if (appConfig?.spotifyClientId) {
    authorizeSpotify(appConfig.spotifyClientId);
  } else {
    const note = document.getElementById('note-sp');
    if (note) {
      note.textContent = 'Error: Spotify Client ID not configured on server.';
      note.style.color = 'var(--accent2)';
    }
    console.error('Spotify login failed: appConfig.spotifyClientId is missing.');
  }
}

// â”€â”€ Spotify helper for 1-click setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSpClientIdDesc() {
  const uri = window.location.origin + '/callbacks';
  return '<strong style="color:var(--text)">Step 1:</strong> Create a free app at ' +
    '<a href="https://developer.spotify.com/dashboard" target="_blank" style="color:var(--accent);text-decoration:none">developer.spotify.com/dashboard</a>.' +
    '<br><br>' +
    '<strong style="color:var(--text)">Step 2:</strong> In your app\'s settings, add this <strong>Redirect URI</strong>:' +
    '<div id="spRedirectUriBox" style="margin:6px 0;padding:6px 8px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);color:var(--accent);font-size:.55rem;word-break:break-all;font-family:\'DM Mono\',monospace;user-select:all;cursor:pointer" onclick="copySpRedirectUri()" title="Click to copy">' + uri + '</div>' +
    '<button class="b-oauth sp-btn" style="margin-bottom:12px;font-size:.58rem;padding:6px;height:auto;letter-spacing:0" onclick="copyAndOpenSpDashboard()">1-Click: Copy URI & Open Dashboard</button>' +
    '<strong style="color:var(--text)">Step 3:</strong> Copy your <strong style="color:var(--accent)">Client ID</strong> from the app dashboard and paste it below.';
}

async function copySpRedirectUri() {
  const uri = window.location.origin + '/callbacks';
  try {
    await navigator.clipboard.writeText(uri);
    const box = document.getElementById('spRedirectUriBox');
    if (box) {
      const old = box.textContent;
      box.textContent = 'COPIED TO CLIPBOARD âœ“';
      box.style.color = 'var(--green)';
      setTimeout(() => { box.textContent = old; box.style.color = ''; }, 2000);
    }
  } catch (err) { console.error('Failed to copy: ', err); }
}

function copyAndOpenSpDashboard() {
  copySpRedirectUri();
  window.open('https://developer.spotify.com/dashboard/create', '_blank');
}

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(svc, mode) {
  state.modal = svc;
  const c = MCFG[svc];
  clearModalError();

  const useSpOAuth = svc === 'sp' && appConfig?.spotifyClientId;
  const useLfOAuth = svc === 'lf' && appConfig?.lastfmApiKey;
  const useDzOAuth = svc === 'dz' && appConfig?.deezerAppId;
  const useOAuth = useSpOAuth || useLfOAuth;

  document.getElementById('mTitle').textContent = c.title;
  document.getElementById('mDesc').innerHTML = c.desc;

  const spOAuthSection = document.getElementById('mSpOAuthSection');
  const oauthSection  = document.getElementById('mOAuthSection');
  const manualSection = document.getElementById('mManualSection');
  const saveBtn       = document.getElementById('mSaveBtn');
  const oauthBtn      = document.getElementById('mOAuthBtn');
  const actions       = document.getElementById('mActions');
  const loadingSec    = document.getElementById('mLoadingSection');
  const successSec    = document.getElementById('mSuccessSection');
  const dzTabs        = document.getElementById('mDeezerTabs');
  const dzOAuthSec    = document.getElementById('mDzOAuthSection');

  // Reset all sections
  loadingSec.style.display   = 'none';
  successSec.style.display   = 'none';
  spOAuthSection.style.display = 'none';
  dzTabs.style.display       = 'none';
  dzOAuthSec.style.display   = 'none';
  actions.style.display      = 'flex';

  // â”€â”€ Spotify: always show server OAuth button (if configured) + manual client ID entry â”€â”€
  if (svc === 'sp') {
    if (mode === 'clientid') {
      // CLIENT ID mode: skip server OAuth, show manual entry with detailed dynamic instructions
      spOAuthSection.style.display = 'none';
      document.getElementById('mTitle').textContent = 'Spotify Client ID';
      document.getElementById('mDesc').innerHTML = getSpClientIdDesc();
    } else if (useSpOAuth) {
      spOAuthSection.style.display = '';
      document.getElementById('mSpOAuthBtn').innerHTML = svgSpotifyIcon(16) + ' ' +
        (state.spToken ? 'Reconnect Spotify' : 'Login with Spotify');
    }
    oauthSection.style.display  = 'none';
    manualSection.style.display = '';
    saveBtn.style.display       = '';
    document.getElementById('mInput').placeholder = c.placeholder || '';
    document.getElementById('mInput').value = state.keys.sp || '';
    document.getElementById('mInput2Wrap').style.display = 'none';
    saveBtn.textContent = 'Login with Spotify';
    setTimeout(() => {
      const inputEl = document.getElementById('mInput');
      inputEl.focus();
      // Add auto-extraction from pasted URL
      inputEl.oninput = (e) => {
        if (state.modal === 'sp') {
          const val = e.target.value.trim();
          const match = val.match(/\/applications\/([a-z0-9]{32})/i);
          if (match && match[1]) {
            e.target.value = match[1];
            showModalError('âœ“ Client ID extracted from URL');
            setTimeout(clearModalError, 3000);
          }
        }
      };
    }, 80);
  }
  // â”€â”€ Deezer: special handling with tabs â”€â”€
  else if (svc === 'dz') {
    oauthSection.style.display = 'none';

    if (useDzOAuth) {
      // Show tabs: OAuth (primary) + ARL (fallback)
      dzTabs.style.display = '';
      document.getElementById('mDesc').innerHTML = 'Log in with your Deezer account to import your favorite artists. Alternatively, use the ARL cookie method.';
      switchDzTab('oauth'); // default to OAuth tab
    } else {
      // No server config: ARL only
      manualSection.style.display = '';
      saveBtn.style.display = '';
      saveBtn.textContent = 'Save';
      document.getElementById('mInput').placeholder = c.placeholder;
      document.getElementById('mInput').value = state.keys.dz || '';
      document.getElementById('mInput2Wrap').style.display = 'none';
    }
  }
  // â”€â”€ Last.fm with pre-configured OAuth â”€â”€
  else if (svc === 'lf') {
    if (mode === 'dev' || !appConfig?.lastfmApiKey) {
      // DEV mode or no server config: show manual entry with dynamic instructions
      oauthSection.style.display  = 'none';
      manualSection.style.display = '';
      saveBtn.style.display       = '';
      document.getElementById('mTitle').textContent = 'Last.fm API Key';
      document.getElementById('mDesc').innerHTML = getLfClientIdDesc();
      document.getElementById('mInput').placeholder = c.placeholder || '';
      document.getElementById('mInput').value = state.lfKey || '';
      const wrap2 = document.getElementById('mInput2Wrap');
      wrap2.style.display = '';
      document.getElementById('mInput2Label').textContent = c.label2 || 'Shared Secret';
      document.getElementById('mInput2').placeholder = c.placeholder2 || '';
      document.getElementById('mInput2').value = state.lfSecret || '';
      saveBtn.textContent = 'Login with Last.fm';
    } else if (useLfOAuth) {
      oauthSection.style.display  = '';
      manualSection.style.display = 'none';
      saveBtn.style.display       = 'none';
      oauthBtn.innerHTML = svgLastfmIcon(16) + ' ' +
        (state.lfSession ? 'Reconnect Last.fm' : 'Login with Last.fm');
      oauthBtn.className = 'b-oauth lf-btn';
    }
    setTimeout(() => {
      const inputEl = document.getElementById('mInput');
      inputEl.focus();
      // Add auto-extraction from pasted URL
      inputEl.oninput = (e) => {
        if (state.modal === 'lf') {
          const val = e.target.value.trim();
          // Extract API key from a pasted Last.fm API page URL (not standard, but helpful if they paste the page)
          const match = val.match(/api_key=([a-f0-9]{32})/i);
          if (match && match[1]) {
            e.target.value = match[1];
            showModalError('âœ“ API Key extracted from URL');
            setTimeout(clearModalError, 3000);
          }
        }
      };
    }, 80);
  }
  // â”€â”€ Manual key entry (fallback) â”€â”€
  else {
    oauthSection.style.display  = 'none';
    manualSection.style.display = '';
    saveBtn.style.display       = '';

    document.getElementById('mInput').placeholder = c.placeholder || '';
    document.getElementById('mInput').value = state.keys[svc] || '';
    const wrap2 = document.getElementById('mInput2Wrap');
    wrap2.style.display = 'none';
    saveBtn.textContent = 'Save';
    setTimeout(() => document.getElementById('mInput').focus(), 80);
  }

  document.getElementById('modalEl').classList.add('open');
}
function closeModal() { document.getElementById('modalEl').classList.remove('open'); state.modal = null; }
function closeModalOutside(e) { if (e.target === document.getElementById('modalEl')) closeModal(); }

// Called by the pre-configured OAuth button â€” opens service login
function startModalOAuth() {
  const s = state.modal;
  if (s === 'sp') {
    authorizeSpotify(appConfig.spotifyClientId);
    showModalLoading('Redirecting to Spotify...');
  } else if (s === 'lf') {
    authorizeLastFm(appConfig.lastfmApiKey);
    showModalLoading('Redirecting to Last.fm...');
  } else if (s === 'dz') {
    openDeezerPopup(appConfig.deezerAppId);
    showModalLoading('Waiting for Deezer...');
  }
}

function saveKey() {
  const s = state.modal;
  // Spotify â€” redirects to Spotify login (manual Client ID entry fallback)
  if (s === 'sp') {
    const clientId = document.getElementById('mInput').value.trim();
    closeModal();
    if (clientId) authorizeSpotify(clientId);
    return;
  }
  // Last.fm â€” redirects to Last.fm login (manual API Key + Shared Secret fallback)
  if (s === 'lf') {
    const key    = document.getElementById('mInput').value.trim();
    const secret = document.getElementById('mInput2').value.trim();
    if (key) {
      if (secret) sessionStorage.setItem('lf_api_secret', secret);
      closeModal();
      authorizeLastFm(key);
    } else {
      closeModal();
    }
    return;
  }
  const k = document.getElementById('mInput').value.trim();
  if (k) {
    state.keys[s] = k;
    const notes = { tm:'Major shows Â· connected âœ“', jb:'Indie venues Â· connected âœ“',
                    eb:'DIY shows Â· connected âœ“', dz:'Favorite artists Â· connected âœ“' };
    activateSourceUI(s, notes[s] || 'Connected âœ“');
    clearCache();
    saveSession();
  }
  closeModal();
}

// â”€â”€ Geocode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function geocode(city) {
  try {
    const r = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`,
      { headers:{'Accept-Language':'en','User-Agent':'RoadShowApp/1.0'} }
    );
    const d = await r.json();
    if (d.length) return {
      lat: parseFloat(d[0].lat), lon: parseFloat(d[0].lon),
      name: d[0].display_name.split(',').slice(0,2).join(',').trim()
    };
  } catch(e) { console.warn('Geocode failed for', city, e); }
  return null;
}

// â”€â”€ Routing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getRoute(pts) {
  const coords = pts.map(p=>`${p.lon},${p.lat}`).join(';');
  try {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), 8000);
    const r = await fetch(
      `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`,
      { signal: controller.signal }
    );
    clearTimeout(timer);
    const d = await r.json();
    if (d.routes?.[0]) return { geo: d.routes[0].geometry, dist: d.routes[0].distance };
  } catch(e) { console.warn('OSRM failed:', e.message); }
  return null;
}

function sampleRoute(geo, n) {
  const c = geo.coordinates;
  const step = Math.max(1, Math.floor(c.length/n));
  return Array.from({length:n}, (_,i) => {
    const p = c[Math.min(i*step, c.length-1)];
    return { lon:p[0], lat:p[1] };
  });
}

// â”€â”€ API: Ticketmaster â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchTM(lat, lon, radius, df, dt, key) {
  const url = `https://app.ticketmaster.com/discovery/v2/events.json?apikey=${key}` +
    `&latlong=${lat},${lon}&radius=${radius}&unit=miles` +
    `&startDateTime=${df}T00:00:00Z&endDateTime=${dt}T23:59:59Z` +
    `&classificationName=music&size=50&sort=date,asc`;
  try {
    const r = await fetch(url);
    const d = await r.json();
    if (d.fault || d.error) {
      activateSourceUI('tm', 'Connection error: check API key', true);
      return [];
    }
    return (d?._embedded?.events || []).map(e => ({
      id:'tm-'+e.id, source:'tm',
      artist: e.name,
      venue:  e._embedded?.venues?.[0]?.name || 'TBA',
      city:   [e._embedded?.venues?.[0]?.city?.name, e._embedded?.venues?.[0]?.state?.stateCode].filter(Boolean).join(', '),
      lat:    parseFloat(e._embedded?.venues?.[0]?.location?.latitude),
      lon:    parseFloat(e._embedded?.venues?.[0]?.location?.longitude),
      datetime: e.dates?.start?.dateTime || (e.dates?.start?.localDate+'T20:00:00'),
      ticketUrl: e.url,
      genre:  e.classifications?.[0]?.genre?.name || null
    }));
  } catch(e) { console.warn('TM error:', e); return []; }
}

// â”€â”€ API: Jambase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchJB(lat, lon, radius, df, dt, key) {
  const url = `https://www.jambase.com/jb-api/v1/events?apikey=${key}` +
    `&geoCoordsLat=${lat}&geoCoordsLon=${lon}&geoRadiusMiles=${radius}` +
    `&eventDateFrom=${df}&eventDateTo=${dt}&perPage=50`;
  try {
    const r = await fetch(url);
    const d = await r.json();
    if (d.errors || d.error) {
      activateSourceUI('jb', 'Connection error: check API key', true);
      return [];
    }
    return (d?.events || []).map(e => ({
      id:'jb-'+e.identifier, source:'jb',
      artist:   (e.performer||[]).map(p=>p.name).join(', ') || 'Unknown',
      venue:    e.location?.name || 'TBA',
      city:     [e.location?.address?.addressLocality, e.location?.address?.addressRegion].filter(Boolean).join(', '),
      lat:      parseFloat(e.location?.geo?.latitude),
      lon:      parseFloat(e.location?.geo?.longitude),
      datetime: e.startDate,
      ticketUrl: e.offers?.[0]?.url || e.url || null,
      genre:    e.performer?.[0]?.genre?.[0] || null
    }));
  } catch(e) { console.warn('JB error:', e); return []; }
}

// â”€â”€ API: Eventbrite â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchEB(lat, lon, radius, df, dt, token) {
  const km = Math.round(radius*1.609);
  const url = `https://www.eventbriteapi.com/v3/events/search/?token=${token}` +
    `&location.latitude=${lat}&location.longitude=${lon}&location.within=${km}km` +
    `&start_date.range_start=${df}T00:00:00&start_date.range_end=${dt}T23:59:59` +
    `&categories=103&expand=venue&page_size=50`;
  try {
    const r = await fetch(url);
    const d = await r.json();
    if (d.error || d.error_description) {
      activateSourceUI('eb', 'Connection error: check private token', true);
      return [];
    }
    return (d?.events || []).map(e => ({
      id:'eb-'+e.id, source:'eb',
      artist:   e.name?.text || 'Event',
      venue:    e.venue?.name || 'TBA',
      city:     [e.venue?.address?.city, e.venue?.address?.region].filter(Boolean).join(', '),
      lat:      parseFloat(e.venue?.latitude),
      lon:      parseFloat(e.venue?.longitude),
      datetime: e.start?.utc || e.start?.local,
      ticketUrl: e.url,
      genre:    'Music'
    }));
  } catch(e) { console.warn('EB error:', e); return []; }
}

// â”€â”€ Spotify PKCE OAuth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spRedirectUri() {
  return window.location.origin + '/callbacks';
}

function generateCodeVerifier() {
  const arr = new Uint8Array(96);
  crypto.getRandomValues(arr);
  return btoa(String.fromCharCode(...arr))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
}

async function generateCodeChallenge(verifier) {
  const digest = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(verifier));
  return btoa(String.fromCharCode(...new Uint8Array(digest)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
}

// â”€â”€ Spotify PKCE OAuth (Direct Redirect) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function authorizeSpotify(clientId) {
  const verifier  = generateCodeVerifier();
  const challenge = await generateCodeChallenge(verifier);
  const oauthState = generateOAuthState('sp');

  sessionStorage.setItem('sp_verifier', verifier);
  sessionStorage.setItem('sp_client_id', clientId);

  const params = new URLSearchParams({
    client_id: clientId,
    response_type: 'code',
    redirect_uri: spRedirectUri(),
    scope: 'user-top-read',
    code_challenge_method: 'S256',
    code_challenge: challenge,
    state: oauthState
  });
  window.location.href = 'https://accounts.spotify.com/authorize?' + params;
}

// â”€â”€ Exchange Spotify auth code for access token (PKCE) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function exchangeSpotifyCode(code, verifier, clientId) {
  let res;
  try {
    res = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        grant_type: 'authorization_code',
        code,
        redirect_uri: spRedirectUri(),
        client_id: clientId,
        code_verifier: verifier
      })
    });
  } catch(e) {
    console.error('Spotify token exchange network error:', e.message);
    showModalError('Spotify authorization failed (network error). Please try again.');
    return;
  }
  const data = await res.json();
  if (!res.ok || data.error) {
    const msg = `Spotify token exchange failed: ${data.error}: ${data.error_description}`;
    console.error(msg);
    showModalError(msg);
    return;
  }
  state.keys.sp       = clientId;
  state.spToken       = data.access_token;
  state.spTokenExpiry = Date.now() + data.expires_in * 1000;
  clearCache();
  saveSession();
  activateSourceUI('sp', 'Artist matching Â· connected âœ“');
  console.log(`âœ“ Spotify authorized (token valid for ${data.expires_in}s)`);
}

// â”€â”€ Handle Spotify callback (Redirect fallback) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleSpotifyCallback() {
  const params = new URLSearchParams(window.location.search);
  const code  = params.get('code');
  const error = params.get('error');
  const receivedState = params.get('state');

  // Only handle if this looks like a Spotify callback (state starts with sp_ or no state for legacy)
  if (receivedState && !receivedState.startsWith('sp_')) return;

  if (code || error) window.history.replaceState({}, '', window.location.pathname);

  if (error) {
    console.warn('Spotify OAuth cancelled or denied:', error);
    return;
  }
  if (!code) return;

  // Non-popup redirect fallback: validate state locally
  if (receivedState && !validateOAuthState('sp', receivedState)) {
    console.error('Spotify CSRF state validation failed.');
    showEmpty('Spotify authorization failed: security state mismatch. Please try again.');
    return;
  }

  const verifier = sessionStorage.getItem('sp_verifier');
  const clientId = sessionStorage.getItem('sp_client_id');
  sessionStorage.removeItem('sp_verifier');
  sessionStorage.removeItem('sp_client_id');
  if (!verifier || !clientId) {
    console.error('Spotify callback: code_verifier or client_id missing.');
    return;
  }
  await exchangeSpotifyCode(code, verifier, clientId);
}

// â”€â”€ Last.fm Web Auth (OAuth-style) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function lfRedirectUri() {
  return window.location.origin + '/callbacks';
}

// Compute Last.fm api_sig: sort params alphabetically, concatenate key+value, append secret, MD5
function lfApiSig(params, secret) {
  return md5(
    Object.keys(params).sort().map(k => k + params[k]).join('') + secret
  );
}

// â”€â”€ Open Last.fm login (Direct Redirect) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function authorizeLastFm(apiKey) {
  sessionStorage.setItem('lf_api_key', apiKey);
  const oauthState = generateOAuthState('lf');
  const cbUrl = lfRedirectUri() + '?lf_state=' + encodeURIComponent(oauthState);
  window.location.href = `https://www.last.fm/api/auth/?api_key=${encodeURIComponent(apiKey)}&cb=${encodeURIComponent(cbUrl)}`;
}

// â”€â”€ Complete Last.fm auth after receiving token (Redirect) â”€â”€â”€â”€â”€â”€â”€â”€
async function completeLastFmAuth(token) {
  const apiKey = sessionStorage.getItem('lf_api_key') || appConfig?.lastfmApiKey || '';
  const secret = sessionStorage.getItem('lf_api_secret');
  sessionStorage.removeItem('lf_api_key');
  sessionStorage.removeItem('lf_api_secret');

  if (appConfig?.lastfmApiKey) {
    // Pre-configured: server-side exchange (Shared Secret never leaves the server)
    let res;
    try {
      res = await fetch('/api/lastfm-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
      });
    } catch(e) {
      console.error('Last.fm server auth error:', e.message);
      showModalError('Last.fm authorization failed (network error). Please try again.');
      return;
    }
    let data;
    try { data = await res.json(); }
    catch { console.error('Last.fm server auth returned non-JSON.'); showModalError('Last.fm authorization failed (invalid response).'); return; }
    if (!res.ok || data.error) {
      const msg = data.error?.message || data.error || JSON.stringify(data);
      console.error('Last.fm server auth failed:', msg);
      showModalError(`Last.fm authorization failed: ${esc(String(msg))}. Please try again.`);
      return;
    }
    state.lfKey    = apiKey;
    state.lfSecret = null; // kept server-side
    state.lfSession = data.session.key;
    state.lfUser    = data.session.name;

  } else if (apiKey && secret) {
    // Manual mode: client-side exchange using the user's own API key + secret
    const sigParams = { api_key: apiKey, method: 'auth.getSession', token };
    const sig = lfApiSig(sigParams, secret);
    let res;
    try {
      res = await fetch(
        `https://ws.audioscrobbler.com/2.0/?method=auth.getSession` +
        `&api_key=${encodeURIComponent(apiKey)}&token=${encodeURIComponent(token)}` +
        `&api_sig=${sig}&format=json`
      );
    } catch(e) {
      console.error('Last.fm client auth error:', e.message);
      showModalError('Last.fm authorization failed (network error). Please try again.');
      return;
    }
    let data;
    try { data = await res.json(); }
    catch { console.error('Last.fm client auth non-JSON.'); showModalError('Last.fm authorization failed (invalid response).'); return; }
    if (data.error) {
      console.error(`Last.fm auth.getSession error ${data.error}: ${data.message}`);
      showModalError(`Last.fm authorization failed (${esc(data.message)}). Please try again.`);
      return;
    }
    state.lfKey     = apiKey;
    state.lfSecret  = secret;
    state.lfSession = data.session.key;
    state.lfUser    = data.session.name;

  } else {
    console.error('Last.fm: no API key or secret available for exchange.');
    showModalError('Last.fm: credentials missing. Please try connecting again.');
    return;
  }

  clearCache();
  saveSession();
  activateSourceUI('lf', `${esc(state.lfUser)} Â· connected âœ“`);
  console.log(`âœ“ Last.fm authorized for ${state.lfUser}`);
}

// â”€â”€ Handle Last.fm callback (Redirect fallback) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleLastFmCallback() {
  const params = new URLSearchParams(window.location.search);
  const token = params.get('token');
  const lfState = params.get('lf_state');
  if (!token) return;
  window.history.replaceState({}, '', window.location.pathname);

  // Non-popup: validate CSRF state
  if (lfState && !validateOAuthState('lf', lfState)) {
    console.error('Last.fm CSRF state validation failed.');
    showEmpty('Last.fm authorization failed: security state mismatch. Please try again.');
    return;
  }

  await completeLastFmAuth(token);
}

// â”€â”€ Session Persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveSession() {
  const data = {
    keys: state.keys,
    spToken: state.spToken, spTokenExpiry: state.spTokenExpiry,
    lfKey: state.lfKey, lfSecret: state.lfSecret, lfSession: state.lfSession, lfUser: state.lfUser,
    dzToken: state.dzToken, dzUser: state.dzUser, dzTokenExpiry: state.dzTokenExpiry,
    startCity: document.getElementById('startCity').value,
    endCity: document.getElementById('endCity').value,
    dateStart: document.getElementById('dateStart').value,
    dateEnd: document.getElementById('dateEnd').value,
    radius: document.getElementById('radiusSlider').value,
    buffer: document.getElementById('bufferSlider').value,
    stops: Array.from(document.querySelectorAll('.stop-input')).map(i => i.value),
    filters: Array.from(state.filters)
  };
  localStorage.setItem('roadshow_session', JSON.stringify(data));
}

function loadSession() {
  const raw = localStorage.getItem('roadshow_session');
  if (!raw) return;
  try {
    const d = JSON.parse(raw);
    state.keys = d.keys || {};
    state.spToken = d.spToken; state.spTokenExpiry = d.spTokenExpiry;
    state.lfKey = d.lfKey; state.lfSecret = d.lfSecret; state.lfSession = d.lfSession; state.lfUser = d.lfUser;
    state.dzToken = d.dzToken; state.dzUser = d.dzUser; state.dzTokenExpiry = d.dzTokenExpiry;
    state.filters = new Set(d.filters || ['tm','jb','eb']);

    if (d.startCity) document.getElementById('startCity').value = d.startCity;
    if (d.endCity)   document.getElementById('endCity').value = d.endCity;
    if (d.dateStart) document.getElementById('dateStart').value = d.dateStart;
    if (d.dateEnd)   document.getElementById('dateEnd').value = d.dateEnd;
    if (d.radius) {
      document.getElementById('radiusSlider').value = d.radius;
      document.getElementById('radiusVal').textContent = d.radius + ' mi';
    }
    if (d.buffer) {
      document.getElementById('bufferSlider').value = d.buffer;
      document.getElementById('bufferVal').textContent = 'Â±' + d.buffer + ' days';
    }

    if (d.stops && d.stops.length > 0) {
      const list = document.getElementById('stopsList');
      list.innerHTML = '';
      d.stops.forEach((s, i) => {
        const row = document.createElement('div');
        row.className = 'stop-row';
        row.innerHTML = `<input type="text" class="stop-input" value="${esc(s)}" placeholder="e.g. Memphis, TN"/>` +
          (i === d.stops.length - 1 && i < MAX_EXTRA_STOPS
            ? `<button class="stop-add-btn" onclick="addStopInput()" title="Add another stop">+</button>`
            : `<button class="stop-rm-btn" onclick="removeStopInput(this)" title="Remove this stop">âˆ’</button>`);
        list.appendChild(row);
      });
    }

    if (state.keys.tm) activateSourceUI('tm', 'Major shows Â· connected âœ“');
    if (state.keys.jb) activateSourceUI('jb', 'Indie venues Â· connected âœ“');
    if (state.keys.eb) activateSourceUI('eb', 'DIY shows Â· connected âœ“');
    if (state.spToken && Date.now() < state.spTokenExpiry) activateSourceUI('sp', 'Artist matching Â· connected âœ“');
    if (state.lfSession) activateSourceUI('lf', `${esc(state.lfUser)} Â· connected âœ“`);
    if (state.dzToken || state.keys.dz) activateSourceUI('dz', 'Connected âœ“');

    updateTripDays();
  } catch(e) { console.warn('Load session failed:', e); }
}

// â”€â”€ Message listener for OAuth popup results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Set up once on the main (non-popup) window. The popup calls postMessage
// with { type: 'deezer_code', ... } before it closes.
function setupPopupListener() {
  window.addEventListener('message', async function(e) {
    if (e.origin !== window.location.origin) return;
    const d = e.data;

    if (d.type === 'deezer_code') {
      // Validate CSRF state for Deezer
      if (d.state && !validateOAuthState('dz', d.state)) {
        console.error('Deezer popup: CSRF state mismatch.');
        showModalError('Deezer authorization failed: security state mismatch.');
        return;
      }
      if (document.getElementById('modalEl').classList.contains('open')) {
        showModalLoading('Exchanging Deezer token...');
      }
      await completeDeezerOAuth(d.code);
      if (state.dzToken && document.getElementById('modalEl').classList.contains('open')) {
        showModalSuccess('Deezer connected!');
      }
    } else if (d.type === 'deezer_error') {
      console.warn('Deezer OAuth denied:', d.error);
      showModalError('Deezer authorization denied: ' + (d.error || 'unknown error'));
    }
  });
}

function activateSourceUI(svc, note, isError) {
  const row = document.getElementById('row-'+svc);
  const noteEl = document.getElementById('note-'+svc);
  const hdr = document.getElementById('hdr-'+svc);
  
  if (isError) {
    row.classList.add('err');
    row.classList.remove('on', 'dim');
    noteEl.textContent = note;
    if (hdr) hdr.classList.add('p-off');
  } else {
    row.classList.add('on');
    row.classList.remove('dim', 'err');
    noteEl.textContent = note;
    if (hdr) hdr.classList.remove('p-off');
  }
}

// â”€â”€ API: Spotify top artists â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchSpotifyArtists() {
  if (!state.spToken) {
    throw new Error(
      'Not connected to Spotify. Click the Spotify "Connect" button and log in to authorize.'
    );
  }
  if (Date.now() >= state.spTokenExpiry) {
    state.spToken = null;
    activateSourceUI('sp', 'Artist matching Â· token expired');
    throw new Error(
      'Your Spotify session expired (tokens last 1 hour). Click the Spotify "Connect" button to log in again.'
    );
  }

  let res;
  try {
    res = await fetch('https://api.spotify.com/v1/me/top/artists?limit=50&time_range=medium_term', {
      headers: { 'Authorization': 'Bearer ' + state.spToken }
    });
  } catch (e) {
    throw new Error(
      'Network error reaching Spotify: ' + e.message + '. ' +
      'Check your internet connection and that no browser extension is blocking api.spotify.com.'
    );
  }

  if (res.status === 401) {
    state.spToken = null;
    throw new Error(
      'Spotify rejected the token with 401 Unauthorized â€” it may have been revoked. ' +
      'Click the Spotify "Connect" button and re-authorize.'
    );
  }
  if (res.status === 403) {
    throw new Error(
      'Spotify returned 403 Forbidden. ' +
      'The authorized app is missing the user-top-read scope. ' +
      'Re-authorize: the scope is requested automatically during the login redirect.'
    );
  }
  if (res.status === 429) {
    const retryAfter = res.headers.get('Retry-After') || 'a few';
    throw new Error(`Spotify rate limit reached (429). Wait ${retryAfter} seconds and try again.`);
  }
  if (!res.ok) {
    throw new Error(
      `Spotify returned an unexpected HTTP ${res.status} ${res.statusText}. ` +
      'This may indicate a Spotify API outage. Check status.spotify.com.'
    );
  }

  let d;
  try { d = await res.json(); }
  catch { throw new Error('Spotify returned a non-JSON response. The API may be temporarily unavailable.'); }

  if (d.error) {
    throw new Error(`Spotify API error ${d.error.status}: ${d.error.message}.`);
  }

  const artists = (d.items || []).map(a => a.name);
  if (artists.length === 0) {
    throw new Error(
      'Spotify returned 0 top artists. ' +
      'This happens when the account has little or no listening history on Spotify.'
    );
  }
  return artists;
}

// â”€â”€ API: Deezer favorite artists (via Netlify proxy â†’ Deezer internal API) â”€â”€
async function fetchDeezerArtists(arl) {
  // â”€â”€ OAuth path: use public API with access_token â”€â”€
  if (state.dzToken) {
    if (state.dzTokenExpiry && Date.now() >= state.dzTokenExpiry) {
      state.dzToken = null;
      activateSourceUI('dz', 'Favorite artists Â· token expired');
      throw new Error('Your Deezer session expired. Click the Deezer "Connect" button to log in again.');
    }
    let res;
    try {
      res = await fetch('https://api.deezer.com/user/me/artists?limit=500&access_token=' + encodeURIComponent(state.dzToken));
    } catch (e) {
      throw new Error('Network error reaching Deezer API: ' + e.message);
    }
    if (!res.ok) {
      throw new Error('Deezer API returned HTTP ' + res.status + '. Token may be expired.');
    }
    let data;
    try { data = await res.json(); }
    catch { throw new Error('Deezer API returned non-JSON.'); }
    if (data.error) {
      throw new Error('Deezer API error: ' + (data.error.message || JSON.stringify(data.error)));
    }
    const artists = (data.data || []).map(a => a.name).filter(Boolean);
    if (artists.length === 0) {
      throw new Error('Deezer returned 0 favorite artists. Add artists to your favorites on deezer.com.');
    }
    return artists;
  }

  // â”€â”€ ARL cookie path (existing implementation) â”€â”€
  // /deezer-proxy is a Netlify Function that forwards requests to
  // deezer.com/ajax/gw-light.php with the ARL injected as a Cookie server-side.
  const GW = '/deezer-proxy';
  const ARL_HEADER = { 'X-Deezer-ARL': arl };

  // â”€â”€ Step 1: getUserData to obtain the session api_token (checkForm) â”€â”€
  let initRes;
  try {
    initRes = await fetch(
      `${GW}?method=deezer.getUserData&input=3&api_version=1.0&api_token=null`,
      { method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8', ...ARL_HEADER },
        body: '{}' }
    );
  } catch (e) {
    throw new Error('Network error reaching Deezer proxy: ' + e.message);
  }

  if (!initRes.ok) {
    throw new Error(
      `Deezer internal API returned HTTP ${initRes.status} ${initRes.statusText} on getUserData. ` +
      'The internal endpoint may have moved or Deezer may be down.'
    );
  }

  let userData;
  try { userData = await initRes.json(); }
  catch {
    throw new Error(
      'Deezer returned a non-JSON response to getUserData. ' +
      'You may not be logged into deezer.com in this browser, or the page returned an HTML error.'
    );
  }

  if (userData.error && Object.keys(userData.error).length > 0) {
    throw new Error(
      `Deezer API error on getUserData: ${JSON.stringify(userData.error)}. ` +
      'Your ARL may be expired. Open deezer.com, log out and back in, then copy a fresh ARL from DevTools â†’ Application â†’ Cookies.'
    );
  }

  const userId = userData.results?.USER?.USER_ID;
  if (!userId || userId === 0) {
    throw new Error(
      'Deezer returned a guest session (USER_ID = 0). ' +
      'This means the browser is not authenticated as your account. ' +
      `The ARL you provided starts with "${arl.slice(0, 10)}..." â€” ` +
      'verify it is copied in full from DevTools (it is typically 192 characters long). ' +
      'Also confirm you are currently logged into deezer.com in this same browser tab.'
    );
  }

  const apiToken = userData.results?.checkForm;
  if (!apiToken) {
    throw new Error(
      'Deezer did not return a session api_token (checkForm field missing). ' +
      'Raw results preview: ' + JSON.stringify(userData.results).slice(0, 300)
    );
  }

  console.log(`âœ“ Deezer session established for user ${userId}`);

  // â”€â”€ Step 2: Fetch user's favorite artists â”€â”€
  // IMPORTANT: Content-Type must be text/plain;charset=UTF-8 for ALL gw-light.php calls.
  // Sending application/json causes GATEWAY_ERROR: Undefined or invalid output.
  let artistsRes;
  try {
    artistsRes = await fetch(
      `${GW}?method=user.getArtists&input=3&api_version=1.0&api_token=${encodeURIComponent(apiToken)}`,
      { method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8', ...ARL_HEADER },
        body: JSON.stringify({ user_id: userId, nb: 500, start: 0 }) }
    );
  } catch (e) {
    throw new Error('Network error fetching Deezer artists: ' + e.message);
  }

  if (!artistsRes.ok) {
    throw new Error(
      `Deezer returned HTTP ${artistsRes.status} ${artistsRes.statusText} on user.getArtists.`
    );
  }

  let artistsRaw, artistsData;
  try {
    artistsRaw = await artistsRes.text();
    artistsData = JSON.parse(artistsRaw);
  } catch {
    throw new Error(
      'Deezer returned non-JSON on user.getArtists. Raw: ' + (artistsRaw || '').slice(0, 200)
    );
  }

  if (artistsData.error && Object.keys(artistsData.error).length > 0) {
    throw new Error(
      `Deezer API error on user.getArtists: ${JSON.stringify(artistsData.error)}. ` +
      'Raw: ' + artistsRaw.slice(0, 300)
    );
  }

  // Deezer sometimes returns GATEWAY_ERROR inside results instead of error
  if (artistsData.results?.GATEWAY_ERROR) {
    throw new Error(
      `Deezer gateway error on user.getArtists: "${artistsData.results.GATEWAY_ERROR}". ` +
      'Raw: ' + artistsRaw.slice(0, 300)
    );
  }

  const artists = (artistsData.results?.data || []).map(a => a.ART_NAME).filter(Boolean);
  if (artists.length === 0) {
    throw new Error(
      'Deezer returned 0 favorite artists. ' +
      'Open deezer.com â†’ your profile â†’ Favorites â†’ Artists and verify you have artists saved. ' +
      'Raw results: ' + JSON.stringify(artistsData.results).slice(0, 300)
    );
  }
  return artists;
}

// â”€â”€ Deezer OAuth 2.0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dzRedirectUri() {
  return window.location.origin + '/callbacks';
}

function openDeezerPopup(appId) {
  const oauthState = generateOAuthState('dz');
  sessionStorage.setItem('dz_popup_app_id', appId);

  const params = new URLSearchParams({
    app_id: appId,
    redirect_uri: dzRedirectUri(),
    perms: 'basic_access,email,manage_library',
    state: oauthState
  });
  const url = 'https://connect.deezer.com/oauth/auth.php?' + params;

  const popup = window.open(url, 'DeezerLogin', 'width=460,height=640,scrollbars=yes,resizable=yes');
  if (!popup) {
    window.location.href = url;
  } else {
    const pollTimer = setInterval(() => {
      if (popup.closed) {
        clearInterval(pollTimer);
        const loadingSec = document.getElementById('mLoadingSection');
        if (loadingSec && loadingSec.style.display !== 'none') {
          loadingSec.style.display = 'none';
          document.getElementById('mDzOAuthSection').style.display = '';
          document.getElementById('mDeezerTabs').style.display = '';
          document.getElementById('mActions').style.display = 'flex';
        }
      }
    }, 500);
  }
}

async function handleDeezerCallback() {
  const params = new URLSearchParams(window.location.search);
  const code  = params.get('code');
  const error = params.get('error_reason');
  const receivedState = params.get('state');

  // Only handle if this looks like a Deezer callback (state starts with dz_)
  const isDeezer = receivedState && receivedState.startsWith('dz_');
  if (!isDeezer) return;

  if (code || error) window.history.replaceState({}, '', window.location.pathname);

  if (error) {
    if (_IS_POPUP_CB && window.opener) {
      window.opener.postMessage({ type: 'deezer_error', error }, window.location.origin);
      setTimeout(() => window.close(), 400);
    } else {
      console.warn('Deezer OAuth cancelled or denied:', error);
    }
    return;
  }
  if (!code) return;

  if (_IS_POPUP_CB && window.opener) {
    window.opener.postMessage(
      { type: 'deezer_code', code, state: receivedState },
      window.location.origin
    );
    document.body.style.cssText =
      'margin:0;height:100vh;background:#0a0a0a;display:flex;align-items:center;justify-content:center';
    document.body.innerHTML =
      '<div style="text-align:center;font-family:\'DM Mono\',monospace;color:#4ade80">' +
      '<div style="font-size:1.8rem;margin-bottom:10px">&#10003;</div>' +
      '<div style="font-size:.6rem;letter-spacing:.14em;opacity:.55">AUTHORIZED &middot; CLOSING</div></div>';
    setTimeout(() => window.close(), 700);
    return;
  }

  // Non-popup redirect fallback: validate state
  if (receivedState && !validateOAuthState('dz', receivedState)) {
    console.error('Deezer CSRF state validation failed.');
    showEmpty('Deezer authorization failed: security state mismatch. Please try again.');
    return;
  }

  await completeDeezerOAuth(code);
}

async function completeDeezerOAuth(code) {
  let res;
  try {
    res = await fetch('/api/deezer-auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code, redirect_uri: dzRedirectUri() })
    });
  } catch (e) {
    console.error('Deezer token exchange network error:', e.message);
    showModalError('Deezer authorization failed (network error). Please try again.');
    return;
  }

  let data;
  try { data = await res.json(); }
  catch {
    console.error('Deezer auth returned non-JSON.');
    showModalError('Deezer authorization failed (invalid server response).');
    return;
  }

  if (!res.ok || data.error) {
    const msg = data.error || 'Unknown error';
    console.error('Deezer auth failed:', msg);
    showModalError('Deezer authorization failed: ' + msg);
    return;
  }

  state.dzToken = data.access_token;
  state.dzUser  = data.user_name || 'Deezer User';
  if (data.expires) {
    state.dzTokenExpiry = Date.now() + parseInt(data.expires) * 1000;
  }
  // Also store the token as the "key" for cache fingerprinting
  state.keys.dz = 'oauth:' + data.access_token.slice(0, 8);
  clearCache();
  activateSourceUI('dz', (state.dzUser ? esc(state.dzUser) + ' Â· ' : '') + 'connected via OAuth');
  console.log('Deezer OAuth authorized for ' + state.dzUser);
}

// â”€â”€ API: Last.fm top artists (uses OAuth session from state) â”€â”€â”€â”€â”€â”€â”€
async function fetchLastFmArtists() {
  if (!state.lfSession || !state.lfUser || !state.lfKey) {
    throw new Error(
      'Not connected to Last.fm. Click the Last.fm "Connect" button, enter your API Key and Shared Secret, then authorize on Last.fm\'s site.'
    );
  }

  // Build authenticated request. When secret is available, sign it for private-profile support.
  const method = 'user.getTopArtists';
  let url;
  if (state.lfSecret) {
    const sigParams = {
      api_key: state.lfKey, limit: '200', method,
      period: 'overall', sk: state.lfSession, user: state.lfUser
    };
    const sig = lfApiSig(sigParams, state.lfSecret);
    url = `https://ws.audioscrobbler.com/2.0/?method=${method}` +
      `&user=${encodeURIComponent(state.lfUser)}&api_key=${encodeURIComponent(state.lfKey)}` +
      `&sk=${encodeURIComponent(state.lfSession)}&limit=200&period=overall` +
      `&api_sig=${sig}&format=json`;
  } else {
    // Server-side auth: secret is not available client-side; sk alone is sufficient for
    // public profiles (the vast majority of Last.fm users).
    url = `https://ws.audioscrobbler.com/2.0/?method=${method}` +
      `&user=${encodeURIComponent(state.lfUser)}&api_key=${encodeURIComponent(state.lfKey)}` +
      `&sk=${encodeURIComponent(state.lfSession)}&limit=200&period=overall&format=json`;
  }

  let res;
  try {
    res = await fetch(url);
  } catch(e) {
    throw new Error(
      'Network error reaching Last.fm: ' + e.message +
      '. Check your internet connection and that ws.audioscrobbler.com is reachable.'
    );
  }

  let d;
  try { d = await res.json(); }
  catch { throw new Error('Last.fm returned a non-JSON response. The service may be temporarily unavailable.'); }

  if (d.error) {
    const known = {
      4:  'Last.fm session has expired or been revoked. Click "Connect" to re-authorize.',
      6:  `Last.fm user "${esc(state.lfUser)}" not found â€” this shouldn\'t happen after OAuth. Try re-authorizing.`,
      9:  'Last.fm session expired. Click the Last.fm "Connect" button to re-authorize.',
      10: 'Invalid Last.fm API key. Double-check the key at last.fm/api/accounts.',
      26: 'This Last.fm API key has been suspended. Check your API account at last.fm/api/accounts.',
      29: 'Last.fm rate limit exceeded. Wait a moment and try again.',
    };
    throw new Error(known[d.error] || `Last.fm API error ${d.error}: ${d.message}`);
  }

  const artists = (d.topartists?.artist || []).map(a => a.name).filter(Boolean);
  if (artists.length === 0) {
    throw new Error(
      `Last.fm returned 0 top artists for "${esc(state.lfUser)}". ` +
      'Scrobble some tracks to build your listening history, or check your privacy settings at last.fm/settings/privacy.'
    );
  }
  return artists;
}

// â”€â”€ Artist matching helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function artistMatchesSet(concertArtist, likedSet) {
  const ca = concertArtist.toLowerCase().trim();
  for (const la of likedSet) {
    if (ca.includes(la) || la.includes(ca)) return true;
  }
  return false;
}

function dedupe(arr) {
  const seen = new Set();
  return arr.filter(c => {
    const k = `${(c.artist||'').toLowerCase().trim()}-${(c.venue||'').toLowerCase().trim()}-${(c.datetime||'').slice(0,10)}`;
    if (seen.has(k)) return false;
    seen.add(k); return true;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Search log (left panel) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function searchLog(msg, type = 'info') {
  const el = document.getElementById('searchLog');
  if (!el) return;
  el.style.display = 'block';
  let body = el.querySelector('.log-body');
  if (!body) {
    el.innerHTML = '<div class="log-hdr">Search Log</div><div class="log-body"></div>';
    body = el.querySelector('.log-body');
  }
  const now = new Date();
  const ts = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
  const cls = type === 'ok' ? 'log-ok' : type === 'err' ? 'log-err' : type === 'warn' ? 'log-warn' : 'log-info';
  const line = document.createElement('div');
  line.className = 'log-line';
  line.innerHTML = `<span class="log-ts">${ts}</span><span class="${cls}">${esc(msg)}</span>`;
  body.appendChild(line);
  el.scrollTop = el.scrollHeight;
}
function clearSearchLog() {
  const el = document.getElementById('searchLog');
  if (el) { el.innerHTML = ''; el.style.display = 'none'; }
}

// â”€â”€ Artist summary (middle panel, above results) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderArtistSummary(spArtists, lfArtists, dzArtists, errors) {
  const panel = document.getElementById('artistSummary');
  if (!panel) return;
  const connected = [
    { key: 'sp', label: 'ðŸŽµ Spotify', artists: spArtists, chipCls: 'chip-sp', divCls: 'as-sp', active: !!state.spToken },
    { key: 'lf', label: 'â—Ž Last.fm',  artists: lfArtists, chipCls: 'chip-lf', divCls: 'as-lf', active: !!state.lfSession },
    { key: 'dz', label: 'ðŸŽ§ Deezer',  artists: dzArtists, chipCls: 'chip-dz', divCls: 'as-dz', active: !!(state.dzToken || state.keys.dz) },
  ].filter(s => s.active);
  if (!connected.length) { panel.innerHTML = ''; panel.className = ''; return; }

  const errMap = {};
  errors.forEach(e => { errMap[e.svc] = e.msg; });
  const total = spArtists.length + lfArtists.length + dzArtists.length;
  const summary = connected.map(s => s.artists.length ? `${s.label.split(' ')[1]} ${s.artists.length}` : '').filter(Boolean).join(' Â· ') || 'none';

  const blocks = connected.map(s => {
    const err = errMap[s.key === 'sp' ? 'Spotify' : s.key === 'lf' ? 'Last.fm' : 'Deezer'];
    if (err) return `<div class="as-svc ${s.divCls}">
      <div class="as-svc-name">${s.label} <span style="color:var(--accent2);font-weight:normal">â€” error</span></div>
      <div style="font-size:.46rem;color:var(--accent2);line-height:1.6">${esc(err)}</div></div>`;
    if (!s.artists.length) return `<div class="as-svc ${s.divCls}">
      <div class="as-svc-name">${s.label} <span style="color:var(--text3);font-weight:normal">â€” 0 artists returned</span></div></div>`;
    const chips = s.artists.map(a => `<span class="artist-chip ${s.chipCls}">${esc(a)}</span>`).join('');
    return `<div class="as-svc ${s.divCls}"><div class="as-svc-name">${s.label} Â· ${s.artists.length}</div><div>${chips}</div></div>`;
  }).join('');

  panel.innerHTML = `<button class="as-toggle open" onclick="toggleArtistSummary(this)">
    <span class="as-label">Artists Â· ${total} loaded â€” ${summary}</span>
    <span class="as-caret">â–´</span></button>
    <div class="as-inner">${blocks}</div>`;
  panel.className = 'open';
}
function toggleArtistSummary(btn) {
  const panel = document.getElementById('artistSummary');
  if (!panel) return;
  const open = panel.classList.toggle('open');
  btn.classList.toggle('open', open);
  btn.querySelector('.as-caret').textContent = open ? 'â–´' : 'â–¾';
}

// â”€â”€ MAIN SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function searchConcerts() {
  const sc = document.getElementById('startCity').value.trim();
  const ec = document.getElementById('endCity').value.trim();
  const st = Array.from(document.querySelectorAll('#stopsList .stop-input'))
    .map(i => i.value.trim()).filter(Boolean).join(',');
  const ds = document.getElementById('dateStart').value;
  const de = document.getElementById('dateEnd').value;

  if (!sc||!ec) { alert('Please enter a start and end city.'); return; }
  if (!ds||!de) { alert('Please select Start Driving and End Trip dates.'); return; }
  const diffDays = Math.ceil((new Date(de+'T00:00:00') - new Date(ds+'T00:00:00')) / 86400000);
  if (diffDays < 0) { alert('End Trip date must be after Start Driving date.'); return; }
  state.lastDiffDays = diffDays;

  const buf = parseInt(document.getElementById('bufferSlider').value);
  const rad = parseInt(document.getElementById('radiusSlider').value);
  const dfD = new Date(ds+'T00:00:00'); dfD.setDate(dfD.getDate()-buf);
  const dtD = new Date(de+'T00:00:00'); dtD.setDate(dtD.getDate()+buf);
  const df = fd(dfD), dt = fd(dtD);

  const names = [sc, ...st.split(',').map(s=>s.trim()).filter(Boolean), ec];
  const ck = cacheKey(names, rad, state.keys);

  // â”€â”€ CACHE HIT: same route+radius+keys, cached dates cover the request â”€â”€
  if (cache.key === ck && cacheDateCovers(df, dt)) {
    cache.hits++;
    clearSearchLog(); searchLog('âš¡ Cache hit â€” showing cached results', 'ok');
    console.log(`âš¡ Cache hit #${cache.hits} â€” filtering ${cache.allConcerts.length} cached â†’ ${df}â€¦${dt}`);

    const concerts = filterByDate(cache.allConcerts, df, dt);
    state.concerts = concerts;

    clearConcertMarkers();
    addConcertMarkers(concerts);
    updateStatsOverlay(concerts, diffDays);
    updateCacheUI();
    renderResults(concerts);
    return;
  }

  // â”€â”€ CACHE MISS: full API fetch â”€â”€
  const btn = document.getElementById('searchBtn');
  btn.disabled=true; btn.textContent='âŸ³ Searching...';
  clearSearchLog();
  const _aSum = document.getElementById('artistSummary'); _aSum.innerHTML=''; _aSum.className='';
  setLB(8); clearMap();

  showEmpty('Geocoding cities...');
  searchLog('â–¶ Geocoding: ' + names.join(' â†’ '));
  console.log('â–¶ Step 1: Geocoding', names);

  const geo = (await Promise.all(names.map(geocode))).filter(Boolean);
  console.log('âœ“ Geocoded:', geo.length, 'cities');
  searchLog('âœ“ ' + geo.length + ' cities located', 'ok');

  if (geo.length < 2) {
    alert('Could not locate your cities. Please check spelling.');
    btn.disabled=false; btn.textContent='âŸ¶ Find Shows'; setLB(0); return;
  }

  setLB(25); showEmpty('Calculating route...');
  const route = await getRoute(geo);
  let waypoints = geo;

  if (route) {
    console.log('âœ“ Route:', Math.round(route.dist/1609), 'miles');
    state.route = L.geoJSON(route.geo, {
      style:{color:'#e8c547',weight:3,opacity:.65,dashArray:'6,4'}
    }).addTo(map);
    const radM = rad * 1609;
    const nWp = Math.min(8, Math.max(2, Math.ceil(route.dist / (radM * 1.75))));
    waypoints = sampleRoute(route.geo, nWp);
    document.getElementById('stDist').textContent = Math.round(route.dist/1609).toLocaleString()+' mi';
    map.fitBounds(state.route.getBounds(), {padding:[50,50]});
  } else {
    const lls = geo.map(p=>[p.lat,p.lon]);
    state.route = L.polyline(lls, {color:'#e8c547',weight:3,opacity:.5,dashArray:'6,4'}).addTo(map);
    map.fitBounds(L.latLngBounds(lls), {padding:[60,60]});
    document.getElementById('stDist').textContent = 'N/A';
  }

  // City markers
  geo.forEach((p,i) => {
    const col = i===0?'#4ade80':i===geo.length-1?'#ff5c38':'#e8c547';
    const r = i===0||i===geo.length-1 ? 9 : 7;
    const m = L.circleMarker([p.lat,p.lon],{radius:r,fillColor:col,color:'#0a0a0a',weight:2,fillOpacity:1})
     .addTo(map).bindPopup(`<b style="font-family:monospace">${esc(names[i])}</b>`);
    state.cityMarkers.push(m);
  });

  // â”€â”€ SESSION CACHE HIT: same route/radius/keys fetched before this session â”€â”€
  const scEntry = sessionCache.get(ck);
  if (scEntry && df >= scEntry.dateFrom && dt <= scEntry.dateTo) {
    cache.key = ck; cache.dateFrom = scEntry.dateFrom; cache.dateTo = scEntry.dateTo;
    cache.allConcerts = scEntry.allConcerts; cache.hits = (cache.hits||0) + 1;
    searchLog('âš¡ Session cache hit â€” skipping API calls', 'ok');
    console.log(`âš¡ Session cache hit â€” filtering ${scEntry.allConcerts.length} cached â†’ ${df}â€¦${dt}`);
    const concerts = filterByDate(scEntry.allConcerts, df, dt);
    state.concerts = concerts;
    clearConcertMarkers();
    addConcertMarkers(concerts);
    updateStatsOverlay(concerts, diffDays);
    updateCacheUI();
    setLB(100); renderResults(concerts);
    setTimeout(()=>setLB(0), 600);
    btn.disabled=false; btn.textContent='âŸ¶ Find Shows';
    return;
  }

  // â”€â”€ Step 3: Spotify / Last.fm / Deezer â†’ build liked-artist set â”€â”€
  let likedArtists = new Set();
  if (state.spToken || state.lfSession || state.keys.dz || state.dzToken) {
    showEmpty('Fetching your artists from music services...');

    const [spResult, lfResult, dzResult] = await Promise.all([
      state.spToken
        ? fetchSpotifyArtists().then(a => ({ ok: true, artists: a })).catch(e => ({ ok: false, svc: 'Spotify', msg: e.message }))
        : Promise.resolve({ ok: true, artists: [] }),
      state.lfSession
        ? fetchLastFmArtists().then(a => ({ ok: true, artists: a })).catch(e => ({ ok: false, svc: 'Last.fm', msg: e.message }))
        : Promise.resolve({ ok: true, artists: [] }),
      (state.dzToken || state.keys.dz)
        ? fetchDeezerArtists(state.keys.dz).then(a => ({ ok: true, artists: a })).catch(e => ({ ok: false, svc: 'Deezer', msg: e.message }))
        : Promise.resolve({ ok: true, artists: [] })
    ]);

    const errors = [];
    if (!spResult.ok) { console.error('Spotify:', spResult.msg); errors.push({ svc: spResult.svc, msg: spResult.msg }); searchLog('âœ— Spotify: ' + spResult.msg, 'err'); }
    if (!lfResult.ok) { console.error('Last.fm:', lfResult.msg); errors.push({ svc: lfResult.svc, msg: lfResult.msg }); searchLog('âœ— Last.fm: ' + lfResult.msg, 'err'); }
    if (!dzResult.ok) { console.error('Deezer:', dzResult.msg); errors.push({ svc: dzResult.svc, msg: dzResult.msg }); searchLog('âœ— Deezer: ' + dzResult.msg, 'err'); }

    const spArtists = spResult.ok ? spResult.artists : [];
    const lfArtists = lfResult.ok ? lfResult.artists : [];
    const dzArtists = dzResult.ok ? dzResult.artists : [];
    [...spArtists, ...lfArtists, ...dzArtists].forEach(a => likedArtists.add(a.toLowerCase().trim()));
    console.log(`âœ“ Liked artists: ${likedArtists.size} (${spArtists.length} Spotify + ${lfArtists.length} Last.fm + ${dzArtists.length} Deezer)`);
    if (spResult.ok && spArtists.length)  searchLog('âœ“ Spotify: ' + spArtists.length + ' artists', 'ok');
    else if (spResult.ok && state.spToken) searchLog('âš  Spotify: 0 artists returned', 'warn');
    if (lfResult.ok && lfArtists.length)  searchLog('âœ“ Last.fm: ' + lfArtists.length + ' artists', 'ok');
    else if (lfResult.ok && state.lfSession) searchLog('âš  Last.fm: 0 artists returned', 'warn');
    if (dzResult.ok && dzArtists.length)  searchLog('âœ“ Deezer: ' + dzArtists.length + ' artists', 'ok');
    else if (dzResult.ok && (state.dzToken || state.keys.dz))  searchLog('âš  Deezer: 0 artists returned', 'warn');
    renderArtistSummary(spArtists, lfArtists, dzArtists, errors);

    if (likedArtists.size === 0) {
      // All connected music services failed â€” show each error prominently
      const html = errors.map(e =>
        `<div style="text-align:left;background:rgba(255,92,56,.07);border:1px solid rgba(255,92,56,.25);` +
        `border-radius:4px;padding:10px 12px;margin-bottom:8px;font-size:.56rem;line-height:1.8;color:var(--text2)">` +
        `<strong style="color:var(--accent2);display:block;margin-bottom:4px">${esc(e.svc)} â€” connection failed</strong>` +
        esc(e.msg) + '</div>'
      ).join('');
      renderArtistSummary(spArtists, lfArtists, dzArtists, errors);
      document.getElementById('resultsScroll').innerHTML =
        `<div style="padding:16px">${html}</div>`;
      btn.disabled=false; btn.textContent='âŸ¶ Find Shows'; setLB(0); return;
    }

    if (errors.length > 0) {
      // Partial success â€” log which service failed but continue with what we have
      errors.forEach(e => console.warn(`âš  ${e.svc} failed (continuing with other service):`, e.msg));
    }
  }

  if (!state.keys.tm && !state.keys.jb && !state.keys.eb) {
    showEmpty('Connect at least one concert source â€” Ticketmaster, Jambase, or Eventbrite â€” to find shows.');
    btn.disabled=false; btn.textContent='âŸ¶ Find Shows'; setLB(0); return;
  }

  setLB(45); showEmpty('Fetching concerts...');
  searchLog('â–¶ Scanning ' + waypoints.length + ' waypoints Â· ' + rad + ' mi radius Â· ' + df + ' â†’ ' + dt);
  console.log('â–¶ Step 4: Fetching | Keys:', {tm:!!state.keys.tm,jb:!!state.keys.jb,eb:!!state.keys.eb,lf:!!state.lfSession});
  console.log('  Waypoints:', waypoints.length, '| Radius:', rad, 'mi | Dates:', df, 'â†’', dt);

  let concerts = [];
  try {
    const batches = await Promise.all(
      waypoints.flatMap(wp => [
        state.keys.tm ? fetchTM(wp.lat,wp.lon,rad,df,dt,state.keys.tm) : Promise.resolve([]),
        state.keys.jb ? fetchJB(wp.lat,wp.lon,rad,df,dt,state.keys.jb) : Promise.resolve([]),
        state.keys.eb ? fetchEB(wp.lat,wp.lon,rad,df,dt,state.keys.eb) : Promise.resolve([])
      ])
    );
    concerts = dedupe(batches.flat());
    console.log('âœ“ API results:', concerts.length, 'shows after dedup');
    searchLog('âœ“ ' + concerts.length + ' shows found on route', 'ok');

    // Filter to liked artists when Spotify/Deezer is connected
    if (likedArtists.size > 0) {
      concerts = concerts.filter(c => artistMatchesSet(c.artist || '', likedArtists));
      console.log(`âœ“ After artist filter: ${concerts.length} shows match your taste`);
      searchLog('âœ“ ' + concerts.length + ' shows match your artists', 'ok');
    }
  } catch(err) {
    console.error('âœ— Concert fetch error:', err);
    searchLog('âœ— Fetch error: ' + err.message, 'err');
    showEmpty('Something went wrong. See console for details.');
    btn.disabled=false; btn.textContent='âŸ¶ Find Shows'; setLB(0); return;
  }

  // â”€â”€ Store in cache â”€â”€
  cache.key = ck;
  cache.dateFrom = df;
  cache.dateTo = dt;
  cache.allConcerts = concerts;
  cache.hits = 0;
  sessionCache.set(ck, { dateFrom: df, dateTo: dt, allConcerts: concerts });
  updateCacheUI();
  console.log(`ðŸ’¾ Cached ${concerts.length} shows for ${df}â†’${dt}`);

  state.concerts = concerts;
  setLB(85);

  addConcertMarkers(concerts);
  updateStatsOverlay(concerts, diffDays);

  setLB(100);
  renderResults(concerts);
  setTimeout(()=>setLB(0), 600);
  searchLog('âœ“ Done â€” ' + concerts.length + ' show' + (concerts.length !== 1 ? 's' : '') + ' displayed', 'ok');
  btn.disabled=false; btn.textContent='âŸ¶ Find Shows';
}

// â”€â”€ Map markers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addConcertMarkers(concerts) {
  concerts.forEach(c => {
    if (!c.lat||!c.lon||isNaN(c.lat)||isNaN(c.lon)) return;
    const m = L.circleMarker([c.lat,c.lon], {
      radius:5, fillColor:SRC_COLORS[c.source]||'#e8c547',
      color:'#0a0a0a', weight:1.5, fillOpacity:.85
    }).addTo(map);
    m.bindPopup(mkPopup(c));
    state.markers.push(m);
  });
}

function updateStatsOverlay(concerts, diffDays) {
  const cnt = {tm:0,jb:0,eb:0};
  concerts.forEach(c => { if (cnt[c.source]!==undefined) cnt[c.source]++; });
  document.getElementById('srcBk').innerHTML = Object.entries(cnt)
    .filter(([,n])=>n>0)
    .map(([s,n])=>`<div class="sk"><span style="color:${SRC_COLORS[s]}">${SRC_LABELS[s]}</span><span style="color:var(--accent)">${n}</span></div>`)
    .join('');
  document.getElementById('stShows').textContent = concerts.length;
  document.getElementById('stVisible').textContent = concerts.length;
  document.getElementById('stTrip').textContent = diffDays + ' day' + (diffDays!==1?'s':'');
  document.getElementById('mapOv').style.display = 'block';
}

// â”€â”€ XSS helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
function safeUrl(u) {
  return typeof u === 'string' && /^https?:\/\//i.test(u) ? u : null;
}

// â”€â”€ Popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mkPopup(c) {
  const {date,time} = fmtDt(c.datetime);
  const sl = SRC_LABELS[c.source] || c.source;
  return `<div style="font-family:'DM Mono',monospace;font-size:.68rem;min-width:155px;line-height:1.7">
    <strong style="font-size:.82rem;display:block;margin-bottom:2px">${esc(c.artist)}</strong>
    ${esc(c.venue)}<br><span style="color:#aaa">${esc(c.city)}</span><br>
    <span style="color:#e8c547">${date} Â· ${time}</span><br>
    <span style="color:#555;font-size:.58rem">${sl}${c.genre?' Â· '+esc(c.genre):''}</span>
    ${safeUrl(c.ticketUrl)?`<br><a href="${esc(c.ticketUrl)}" target="_blank" style="color:#ff5c38;text-decoration:none;display:inline-block;margin-top:3px">ðŸŽŸ Tickets</a>`:''}
  </div>`;
}

// â”€â”€ Render results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults(concerts) {
  document.getElementById('rctrlBar').style.display = concerts.length ? 'flex' : 'none';
  document.getElementById('rcLabel').textContent = concerts.length
    ? `${concerts.length} show${concerts.length!==1?'s':''} found`
    : 'No results';

  if (!concerts.length) {
    showEmpty('No shows found along your route.<br>Try a wider radius or date buffer.');
    return;
  }

  document.getElementById('resultsScroll').innerHTML = '<div id="cList"></div>';
  renderList(concerts);
}

function renderList(concerts) {
  const filtered = concerts.filter(c => state.filters.has(c.source));
  document.getElementById('cList').innerHTML = filtered.map((c,i) => mkCard(c,i)).join('');
  const vis = document.getElementById('stVisible');
  if (vis) vis.textContent = filtered.length;
}

function toggleFilter(src) {
  const btn = document.getElementById('flt-'+src);
  if (state.filters.has(src)) { state.filters.delete(src); btn.className='fb'; }
  else { state.filters.add(src); btn.className=`fb f-${src}`; }
  renderList(state.concerts);
}

function sortBy(m) {
  const s = [...state.concerts];
  if (m==='date')   s.sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
  if (m==='artist') s.sort((a,b)=>a.artist.localeCompare(b.artist));
  if (m==='source') s.sort((a,b)=>a.source.localeCompare(b.source));
  if (m==='city')   s.sort((a,b)=>(a.city||'').localeCompare(b.city||''));
  state.concerts = s;
  renderList(s);
}

function mkCard(c,i) {
  const {date,time} = fmtDt(c.datetime);
  const stc = {tm:'t-tm',jb:'t-jb',eb:'t-eb'}[c.source]||'t-gen';
  const slb = SRC_LABELS[c.source]||c.source;
  const hq  = encodeURIComponent(`hotels near ${c.venue} ${c.city}`);
  return `<div class="cc s-${c.source}" style="animation-delay:${i*18}ms" onclick="zoomTo(${c.lat},${c.lon})">
    <div class="ct">
      <div class="an">${esc(c.artist)}</div>
      <div class="cd">${date}<br>${time}</div>
    </div>
    <div class="vn">${esc(c.venue)}</div>
    <div class="ctags">
      <span class="tag t-city">${esc(c.city)}</span>
      <span class="tag ${stc}">${slb}</span>
      ${c.genre?`<span class="tag t-gen">${esc(c.genre)}</span>`:''}
    </div>
    <div class="ca">
      ${safeUrl(c.ticketUrl)
        ?`<a href="${esc(c.ticketUrl)}" target="_blank" class="bs b-tk" onclick="event.stopPropagation()">ðŸŽŸ Tickets</a>`
        :`<span class="bs b-gh" style="opacity:.35;cursor:default">ðŸŽŸ No link</span>`}
      <button class="bs b-gh" onclick="event.stopPropagation();zoomTo(${c.lat},${c.lon})">ðŸ“ Map</button>
      <a href="https://www.google.com/maps/search/${hq}" target="_blank" class="bs b-gh" onclick="event.stopPropagation()">ðŸ¨ Hotels</a>
    </div>
  </div>`;
}

function zoomTo(lat, lon) {
  if (!lat||!lon||isNaN(lat)||isNaN(lon)) return;
  map.setView([lat,lon], 13, {animate:true});
}

// â”€â”€ Handle OAuth returns on page load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (_IS_POPUP_CB) {
  // This page is a popup handling a callback â€” run handlers immediately,
  // no need to load config or set up the full app.
  handleSpotifyCallback();
  handleLastFmCallback();
  handleDeezerCallback();
} else {
  // Normal page load: set up popup message listener first, then load config
  // so the modal buttons know whether pre-configured OAuth is available.
  setupPopupListener();
  loadConfig().then(() => {
    loadSession();
    handleSpotifyCallback(); // handles any redirect-fallback code in URL
    handleLastFmCallback();  // handles any redirect-fallback token in URL
    handleDeezerCallback();  // handles any redirect-fallback code in URL

    // Auto-save on form changes
    document.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('input', saveSession);
    });
  });
}

</script>
</body>
</html>
